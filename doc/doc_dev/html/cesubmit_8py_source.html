<!-- HTML header for doxygen 1.8.5-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.6.1"/>
<!--BEGIN PROJECT_NAME--><title>libs3a: libs3a: python/cesubmit.py Source File</title><!--END PROJECT_NAME-->
<!--BEGIN !PROJECT_NAME--><title>libs3a: python/cesubmit.py Source File</title><!--END !PROJECT_NAME-->
<link href="$relpath^tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="$relpath^jquery.js"></script>
<script type="text/javascript" src="$relpath^dynsections.js"></script>
$treeview
$search
$mathjax
<link href="$relpath^$stylesheet" rel="stylesheet" type="text/css" />
$extrastylesheet
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->

<!--BEGIN TITLEAREA-->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <!--BEGIN PROJECT_LOGO-->
  <td id="projectlogo"><img alt="Logo" src="$relpath^$projectlogo"/></td>
  <!--END PROJECT_LOGO-->
  <!--BEGIN PROJECT_NAME-->
  <td style="padding-left: 0.5em;">
   <div id="projectname">libs3a
   <!--BEGIN PROJECT_NUMBER-->&#160;<span id="projectnumber"></span><!--END PROJECT_NUMBER-->
   </div>
   <!--BEGIN PROJECT_BRIEF--><div id="projectbrief">$projectbrief</div><!--END PROJECT_BRIEF-->
  </td>
  <!--END PROJECT_NAME-->
  <!--BEGIN !PROJECT_NAME-->
   <!--BEGIN PROJECT_BRIEF-->
    <td style="padding-left: 0.5em;">
    <div id="projectbrief">$projectbrief</div>
    </td>
   <!--END PROJECT_BRIEF-->
  <!--END !PROJECT_NAME-->
  <!--BEGIN DISABLE_INDEX-->
   <!--BEGIN SEARCHENGINE-->
   <td>$searchbox</td>
   <!--END SEARCHENGINE-->
  <!--END DISABLE_INDEX-->
    <td style="padding-left: 20.5em;">
      <div> Choose your branch:</div>
  </td>
  <td style="padding-left: .5em;">
      <div align=right><select id="choose_branch">
        <option value="">Change branch</option>
        <option value="http://aachen-3a.github.io/libs3a/doc/doc_master/html/index.html">master</option>
<option value="http://aachen-3a.github.io/libs3a/doc/doc_dev/html/index.html">dev</option>
        </select>
     </div>   
    <script>
        document.getElementById("choose_branch").onchange = function() {
                if (this.selectedIndex!==0) {
                            window.location.href = this.value;
                            //window.open( this.value ); 
                }        
            };
    </script>
  </td>
  <td style="padding-left: 15.5em;">
      <div> Get back to <a href="https://github.com/Aachen-3A/libs3a">GitHub</a></div>
  </td> 
  <td style="padding-left: 0.2em;">
      <div> or </div>
  </td> 
  <td style="padding-left: 0.2em;">
      <div> <a href="https://github.com/Aachen-3A/TAPAS">TAPAS main page</a></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!--END TITLEAREA-->
<!-- end header part -->
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
<h1>python/cesubmit.py</h1><a href="cesubmit_8py.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a><a class="code" href="namespacecesubmit.html">00001</a> <span class="comment">#! /usr/bin/env python2</span>
<a name="l00002"></a>00002 <span class="keyword">import</span> time
<a name="l00003"></a>00003 <span class="keyword">import</span> sys
<a name="l00004"></a>00004 <span class="keyword">import</span> os
<a name="l00005"></a>00005 <span class="keyword">import</span> subprocess
<a name="l00006"></a>00006 <span class="keyword">import</span> pickle
<a name="l00007"></a>00007 <span class="keyword">import</span> shutil
<a name="l00008"></a>00008 <span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict
<a name="l00009"></a>00009 <span class="keyword">import</span> multiprocessing
<a name="l00010"></a>00010 <span class="keyword">import</span> logging
<a name="l00011"></a>00011 <span class="keyword">import</span> glob
<a name="l00012"></a>00012 <span class="keyword">import</span> re
<a name="l00013"></a>00013 <span class="comment">#logging.basicConfig(level=logging.INFO)</span>
<a name="l00014"></a><a class="code" href="namespacecesubmit.html#a3b34d9950203da7d2af9d12ac0705c1c">00014</a> log = logging.getLogger(__name__)
<a name="l00015"></a>00015 <span class="comment">#log = multiprocessing.get_logger()</span>
<a name="l00016"></a>00016 
<a name="l00017"></a><a class="code" href="namespacecesubmit.html#a298eaa367b8d30ccac27bc38a2529659">00017</a> <span class="keyword">def </span><a class="code" href="namespacecesubmit.html#a298eaa367b8d30ccac27bc38a2529659">submitWorker</a>(job):
<a name="l00018"></a>00018     job.submit()
<a name="l00019"></a>00019     <span class="keywordflow">return</span> job
<a name="l00020"></a>00020 
<a name="l00021"></a><a class="code" href="namespacecesubmit.html#a0cc3b175856081fdc1f6f713fcd3a141">00021</a> <span class="keyword">def </span><a class="code" href="namespacecesubmit.html#a0cc3b175856081fdc1f6f713fcd3a141">resubmitWorker</a>(job):
<a name="l00022"></a>00022     job.resubmit()
<a name="l00023"></a>00023     <span class="keywordflow">return</span> job
<a name="l00024"></a>00024 
<a name="l00025"></a><a class="code" href="namespacecesubmit.html#a4a2cde93eeebda8d8743bf0ed1bb058f">00025</a> <span class="keyword">def </span><a class="code" href="namespacecesubmit.html#a4a2cde93eeebda8d8743bf0ed1bb058f">killWorker</a>(job):
<a name="l00026"></a>00026     job.kill()
<a name="l00027"></a>00027     <span class="keywordflow">return</span> job
<a name="l00028"></a>00028 
<a name="l00029"></a><a class="code" href="classcesubmit_1_1Job.html">00029</a> <span class="keyword">class </span><a class="code" href="classcesubmit_1_1Job.html">Job</a>:
<a name="l00030"></a><a class="code" href="classcesubmit_1_1Job.html#a3818b15f45e147f2260796cfb9f0851e">00030</a>     <span class="keyword">def </span><a class="code" href="classcesubmit_1_1Job.html#a3818b15f45e147f2260796cfb9f0851e">__init__</a>(self):
<a name="l00031"></a><a class="code" href="classcesubmit_1_1Job.html#a0345d0954e4cff463c89d081c62ff263">00031</a>         self.inputfiles, self.outputfiles, self.arguments , self.<a class="code" href="classcesubmit_1_1Job.html#a0345d0954e4cff463c89d081c62ff263">executable</a> = [], [], [], <span class="keywordtype">None</span>
<a name="l00032"></a><a class="code" href="classcesubmit_1_1Job.html#ad55395950074fcee08e9ab68c63ffbc6">00032</a>         self.<a class="code" href="classcesubmit_1_1Job.html#ad55395950074fcee08e9ab68c63ffbc6">frontEndStatus</a> = <span class="stringliteral">&quot;&quot;</span>
<a name="l00033"></a><a class="code" href="classcesubmit_1_1Job.html#a72513b2a7d6889f795c45652cf2cfb8e">00033</a>         self.<a class="code" href="classcesubmit_1_1Job.html#a72513b2a7d6889f795c45652cf2cfb8e">jobid</a>=<span class="keywordtype">None</span>
<a name="l00034"></a>00034     @property
<a name="l00035"></a><a class="code" href="classcesubmit_1_1Job.html#aab5365b3032f68465c8705e342caab45">00035</a>     <span class="keyword">def </span><a class="code" href="classcesubmit_1_1Job.html#aab5365b3032f68465c8705e342caab45">status</a>(self):
<a name="l00036"></a>00036         <span class="keywordflow">try</span>:
<a name="l00037"></a>00037             status=str(self.<a class="code" href="classcesubmit_1_1Job.html#a5d79f9e0207a1d688c2b8d780f3736e7">infos</a>[<span class="stringliteral">&quot;Status&quot;</span>])
<a name="l00038"></a>00038         <span class="keywordflow">except</span>:
<a name="l00039"></a>00039             status=<span class="stringliteral">&quot;None&quot;</span>
<a name="l00040"></a>00040         <span class="keywordflow">return</span> status
<a name="l00041"></a><a class="code" href="classcesubmit_1_1Job.html#a79187a8e7270a742b9aa870a4d477391">00041</a>     <span class="keyword">def </span><a class="code" href="classcesubmit_1_1Job.html#a79187a8e7270a742b9aa870a4d477391">writeJdl</a>(self):
<a name="l00042"></a>00042         <span class="keywordflow">if</span> self.<a class="code" href="classcesubmit_1_1Job.html#a0345d0954e4cff463c89d081c62ff263">executable</a> <span class="keywordflow">is</span> <span class="keywordtype">None</span>: self.<a class="code" href="classcesubmit_1_1Job.html#a0345d0954e4cff463c89d081c62ff263">executable</a> = self.task.executable
<a name="l00043"></a>00043         jdl = (
<a name="l00044"></a>00044             <span class="stringliteral">&apos;[Type = &quot;Job&quot;;\n&apos;</span>
<a name="l00045"></a>00045             <span class="stringliteral">&apos;VirtualOrganisation = &quot;cms&quot;;\n&apos;</span>
<a name="l00046"></a>00046             <span class="stringliteral">&apos;AllowZippedISB = true;\n&apos;</span>
<a name="l00047"></a>00047             <span class="comment">#&apos;Requirements = (RegExp(&quot;rwth-aachen.de&quot;, other.GlueCEUniqueId)) &amp;&amp; (RegExp(&quot;cream&quot;, other.GlueCEUniqueId)) &amp;&amp; !(RegExp(&quot;short&quot;, other.GlueCEUniqueId));\n&apos;</span>
<a name="l00048"></a>00048             <span class="stringliteral">&apos;ShallowRetryCount = 10;\n&apos;</span>
<a name="l00049"></a>00049             <span class="stringliteral">&apos;RetryCount = 3;\n&apos;</span>
<a name="l00050"></a>00050             <span class="stringliteral">&apos;MyProxyServer = &quot;&quot;;\n&apos;</span>
<a name="l00051"></a>00051             <span class="stringliteral">&apos;executable = &quot;prologue.sh&quot;;\n&apos;</span>
<a name="l00052"></a>00052             <span class="stringliteral">&apos;StdOutput = &quot;out.txt&quot;;\n&apos;</span>
<a name="l00053"></a>00053             <span class="stringliteral">&apos;StdError  = &quot;err.txt&quot;;\n&apos;</span>
<a name="l00054"></a>00054             <span class="stringliteral">&apos;outputsandboxbasedesturi=&quot;gsiftp://localhost&quot;;\n&apos;</span>
<a name="l00055"></a>00055             )
<a name="l00056"></a>00056 
<a name="l00057"></a>00057         jdl += <span class="stringliteral">&apos;InputSandbox = { &quot;&apos;</span> + (<span class="stringliteral">&apos;&quot;, &quot;&apos;</span>.join([<span class="stringliteral">&quot;./prologue.sh&quot;</span>, self.<a class="code" href="classcesubmit_1_1Job.html#a0345d0954e4cff463c89d081c62ff263">executable</a>]+self.inputfiles+self.task.inputfiles)) + <span class="stringliteral">&apos;&quot;};\n&apos;</span>
<a name="l00058"></a>00058         stds=[<span class="stringliteral">&quot;out.txt&quot;</span>, <span class="stringliteral">&quot;err.txt&quot;</span>]
<a name="l00059"></a>00059         jdl += <span class="stringliteral">&apos;OutputSandbox = { &quot;&apos;</span> + (<span class="stringliteral">&apos;&quot;, &quot;&apos;</span>.join(stds+self.outputfiles+self.task.outputfiles)) + <span class="stringliteral">&apos;&quot;};\n&apos;</span>
<a name="l00060"></a>00060         jdl += <span class="stringliteral">&apos;Arguments = &quot;&apos;</span> + (<span class="stringliteral">&apos; &apos;</span>.join([<span class="stringliteral">&quot;./&quot;</span>+os.path.basename(self.<a class="code" href="classcesubmit_1_1Job.html#a0345d0954e4cff463c89d081c62ff263">executable</a>)] + self.arguments)) + <span class="stringliteral">&apos;&quot;;\n&apos;</span>
<a name="l00061"></a>00061         jdl += <span class="stringliteral">&quot;]&quot;</span>
<a name="l00062"></a><a class="code" href="classcesubmit_1_1Job.html#ad0e432f12a4d08b3ee4acd26616cc85e">00062</a>         self.<a class="code" href="classcesubmit_1_1Job.html#ad0e432f12a4d08b3ee4acd26616cc85e">jdlfilename</a> = <span class="stringliteral">&quot;job&quot;</span>+str(self.nodeid)+<span class="stringliteral">&quot;.jdl&quot;</span>
<a name="l00063"></a>00063         jdl_file = open(self.<a class="code" href="classcesubmit_1_1Job.html#ad0e432f12a4d08b3ee4acd26616cc85e">jdlfilename</a>, <span class="stringliteral">&apos;w&apos;</span>)
<a name="l00064"></a>00064         jdl_file.write(jdl)
<a name="l00065"></a>00065         jdl_file.close()
<a name="l00066"></a>00066         self.<a class="code" href="classcesubmit_1_1Job.html#ad55395950074fcee08e9ab68c63ffbc6">frontEndStatus</a> = <span class="stringliteral">&quot;JDLWRITTEN&quot;</span>
<a name="l00067"></a><a class="code" href="classcesubmit_1_1Job.html#a687826fb1ad7266324287b5cb34da8b6">00067</a>     <span class="keyword">def </span><a class="code" href="classcesubmit_1_1Job.html#a687826fb1ad7266324287b5cb34da8b6">submit</a>(self):
<a name="l00068"></a>00068         startdir = os.getcwd()
<a name="l00069"></a>00069         <span class="keywordflow">if</span> startdir!=self.task.directory:
<a name="l00070"></a>00070             os.chdir(self.task.directory)
<a name="l00071"></a>00071 
<a name="l00072"></a>00072         <span class="comment">#get a proxy for at least 4 days</span>
<a name="l00073"></a>00073         checkAndRenewVomsProxy(604800)
<a name="l00074"></a>00074         <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(50):
<a name="l00075"></a>00075             <span class="comment">#command = [&apos;glite-ce-job-submit&apos;, &apos;-a&apos;, &apos;-r&apos;, &apos;ce201.cern.ch:8443/cream-lsf-grid_cms&apos;, self.jdlfilename]</span>
<a name="l00076"></a>00076             command = [<span class="stringliteral">&apos;glite-ce-job-submit&apos;</span>, <span class="stringliteral">&apos;-a&apos;</span>, <span class="stringliteral">&apos;-r&apos;</span>, self.task.ceId, self.<a class="code" href="classcesubmit_1_1Job.html#ad0e432f12a4d08b3ee4acd26616cc85e">jdlfilename</a>]
<a name="l00077"></a>00077             process = subprocess.Popen(command, stdout=subprocess.PIPE)
<a name="l00078"></a>00078             stdout, stderr = process.communicate()
<a name="l00079"></a>00079             <span class="keywordflow">if</span> <span class="stringliteral">&quot;FATAL&quot;</span> <span class="keywordflow">in</span> stdout <span class="keywordflow">and</span> <span class="stringliteral">&quot;Submissions are disabled!&quot;</span> <span class="keywordflow">in</span> stdout:
<a name="l00080"></a>00080                 <span class="keywordflow">print</span> <span class="stringliteral">&quot;Submission server seems busy (Submissions are disabled). Waiting...&quot;</span>
<a name="l00081"></a>00081                 time.sleep(60*(i+1))
<a name="l00082"></a>00082                 <span class="keywordflow">continue</span>
<a name="l00083"></a>00083             <span class="keywordflow">if</span> <span class="stringliteral">&quot;FATAL - jobRegister&quot;</span> <span class="keywordflow">in</span> stdout:
<a name="l00084"></a>00084                 <span class="keywordflow">print</span> <span class="stringliteral">&quot;Submission server seems busy (jobRegister). Waiting...&quot;</span>
<a name="l00085"></a>00085                 time.sleep(60*(i+1))
<a name="l00086"></a>00086                 <span class="keywordflow">continue</span>
<a name="l00087"></a>00087             <span class="keywordflow">if</span> <span class="stringliteral">&quot;FATAL&quot;</span> <span class="keywordflow">in</span> stdout <span class="keywordflow">and</span> <span class="stringliteral">&quot;Connection timed out&quot;</span> <span class="keywordflow">in</span> stdout:
<a name="l00088"></a>00088                 <span class="keywordflow">print</span> <span class="stringliteral">&quot;Submission server seems busy (Connection timed out). Waiting...&quot;</span>
<a name="l00089"></a>00089                 time.sleep(60*(i+1))
<a name="l00090"></a>00090                 <span class="keywordflow">continue</span>
<a name="l00091"></a>00091             <span class="keywordflow">if</span> <span class="stringliteral">&quot;FATAL - EOF detected during communication&quot;</span> <span class="keywordflow">in</span> stdout:
<a name="l00092"></a>00092                 <span class="keywordflow">print</span> <span class="stringliteral">&quot;Submission server seems busy (EOF detected during communication). Waiting...&quot;</span>
<a name="l00093"></a>00093                 time.sleep(60*(i+1))
<a name="l00094"></a>00094                 <span class="keywordflow">continue</span>
<a name="l00095"></a>00095             <span class="keywordflow">if</span> <span class="stringliteral">&quot;FATAL&quot;</span> <span class="keywordflow">in</span> stdout <span class="keywordflow">or</span> <span class="stringliteral">&quot;ERROR&quot;</span> <span class="keywordflow">in</span> stdout <span class="keywordflow">or</span> process.returncode != 0:
<a name="l00096"></a>00096                 log.error(<span class="stringliteral">&apos;Submission failed.&apos;</span>)
<a name="l00097"></a>00097                 log.error(<span class="stringliteral">&apos;Output:\n&apos;</span> + stdout)
<a name="l00098"></a><a class="code" href="classcesubmit_1_1Job.html#ae9f93c95244ac72baebb65271e7974eb">00098</a>                 self.<a class="code" href="classcesubmit_1_1Job.html#ae9f93c95244ac72baebb65271e7974eb">error</a> = stdout
<a name="l00099"></a>00099                 <span class="keywordflow">break</span>
<a name="l00100"></a>00100             self.<a class="code" href="classcesubmit_1_1Job.html#ad55395950074fcee08e9ab68c63ffbc6">frontEndStatus</a> = <span class="stringliteral">&quot;SENT&quot;</span>
<a name="l00101"></a>00101             log.info(<span class="stringliteral">&apos;Submission successful.&apos;</span>)
<a name="l00102"></a>00102             <span class="keywordflow">for</span> line <span class="keywordflow">in</span> stdout.splitlines():
<a name="l00103"></a>00103                 <span class="keywordflow">if</span> <span class="stringliteral">&quot;https://&quot;</span> <span class="keywordflow">in</span> line:
<a name="l00104"></a>00104                     self.<a class="code" href="classcesubmit_1_1Job.html#a72513b2a7d6889f795c45652cf2cfb8e">jobid</a> = line.strip()
<a name="l00105"></a>00105                     log.info(<span class="stringliteral">&quot;Submitted job &quot;</span>+self.<a class="code" href="classcesubmit_1_1Job.html#a72513b2a7d6889f795c45652cf2cfb8e">jobid</a>)
<a name="l00106"></a>00106             <span class="keywordflow">break</span>
<a name="l00107"></a>00107         os.chdir(startdir)
<a name="l00108"></a>00108         <span class="keywordflow">return</span> process.returncode, stdout
<a name="l00109"></a><a class="code" href="classcesubmit_1_1Job.html#a7648d08aa5c5cb853be9879b01cc96bd">00109</a>     <span class="keyword">def </span><a class="code" href="classcesubmit_1_1Job.html#a7648d08aa5c5cb853be9879b01cc96bd">getStatus</a>(self):
<a name="l00110"></a>00110         <span class="keywordflow">if</span> self.<a class="code" href="classcesubmit_1_1Job.html#ad55395950074fcee08e9ab68c63ffbc6">frontEndStatus</a> == <span class="stringliteral">&quot;RETRIEVED&quot;</span> <span class="keywordflow">or</span> self.<a class="code" href="classcesubmit_1_1Job.html#ad55395950074fcee08e9ab68c63ffbc6">frontEndStatus</a> == <span class="stringliteral">&quot;PURGED&quot;</span> <span class="keywordflow">or</span> self.<a class="code" href="classcesubmit_1_1Job.html#a72513b2a7d6889f795c45652cf2cfb8e">jobid</a> <span class="keywordflow">is</span> <span class="keywordtype">None</span>:
<a name="l00111"></a>00111             <span class="keywordflow">return</span>
<a name="l00112"></a>00112         command = [<span class="stringliteral">&quot;glite-ce-job-status&quot;</span>, self.<a class="code" href="classcesubmit_1_1Job.html#a72513b2a7d6889f795c45652cf2cfb8e">jobid</a>]
<a name="l00113"></a>00113         log.debug(<span class="stringliteral">&quot;Getting status &quot;</span>+self.<a class="code" href="classcesubmit_1_1Job.html#a72513b2a7d6889f795c45652cf2cfb8e">jobid</a>)
<a name="l00114"></a>00114         process = subprocess.Popen(command, stdout=subprocess.PIPE)
<a name="l00115"></a>00115         stdout, stderr = process.communicate()
<a name="l00116"></a>00116         <span class="keywordflow">if</span> process.returncode!=0:
<a name="l00117"></a>00117             log.warning(<span class="stringliteral">&apos;Status retrieval failed for job id &apos;</span>+self.<a class="code" href="classcesubmit_1_1Job.html#a72513b2a7d6889f795c45652cf2cfb8e">jobid</a>)
<a name="l00118"></a>00118             log.info(stdout)
<a name="l00119"></a>00119             log.info(stderr)
<a name="l00120"></a><a class="code" href="classcesubmit_1_1Job.html#a5d79f9e0207a1d688c2b8d780f3736e7">00120</a>         self.<a class="code" href="classcesubmit_1_1Job.html#a5d79f9e0207a1d688c2b8d780f3736e7">infos</a> = parseStatus(stdout)
<a name="l00121"></a><a class="code" href="classcesubmit_1_1Job.html#ae951dccd7548e4baca3084defbaeffbb">00121</a>     <span class="keyword">def </span><a class="code" href="classcesubmit_1_1Job.html#ae951dccd7548e4baca3084defbaeffbb">getOutput</a>(self):
<a name="l00122"></a>00122         <span class="keywordflow">if</span> self.<a class="code" href="classcesubmit_1_1Job.html#a72513b2a7d6889f795c45652cf2cfb8e">jobid</a> <span class="keywordflow">is</span> <span class="keywordtype">None</span>:
<a name="l00123"></a>00123             <span class="keywordflow">return</span>
<a name="l00124"></a>00124         log.debug(<span class="stringliteral">&quot;Getting output &quot;</span>+self.<a class="code" href="classcesubmit_1_1Job.html#a72513b2a7d6889f795c45652cf2cfb8e">jobid</a>)
<a name="l00125"></a>00125         command = [<span class="stringliteral">&quot;glite-ce-job-output&quot;</span>, <span class="stringliteral">&quot;--noint&quot;</span>, <span class="stringliteral">&quot;--dir&quot;</span>, self.task.directory, self.<a class="code" href="classcesubmit_1_1Job.html#a72513b2a7d6889f795c45652cf2cfb8e">jobid</a>]
<a name="l00126"></a>00126         process = subprocess.Popen(command, stdout=subprocess.PIPE)
<a name="l00127"></a>00127         stdout, stderr = process.communicate()
<a name="l00128"></a>00128         <span class="keywordflow">if</span> process.returncode!=0:
<a name="l00129"></a>00129             log.warning(<span class="stringliteral">&apos;Output retrieval failed for job id &apos;</span>+self.<a class="code" href="classcesubmit_1_1Job.html#a72513b2a7d6889f795c45652cf2cfb8e">jobid</a>)
<a name="l00130"></a>00130         <span class="keywordflow">else</span>:
<a name="l00131"></a>00131             self.<a class="code" href="classcesubmit_1_1Job.html#abae1efe849e60ec5654a0e3bcf8b53de">purge</a>()
<a name="l00132"></a>00132             self.<a class="code" href="classcesubmit_1_1Job.html#ad55395950074fcee08e9ab68c63ffbc6">frontEndStatus</a> = <span class="stringliteral">&quot;RETRIEVED&quot;</span>
<a name="l00133"></a><a class="code" href="classcesubmit_1_1Job.html#af6312c9aa24591f79db86d89b5e0ff6b">00133</a>     <span class="keyword">def </span><a class="code" href="classcesubmit_1_1Job.html#af6312c9aa24591f79db86d89b5e0ff6b">cancel</a>(self):
<a name="l00134"></a>00134         <span class="keywordflow">if</span> self.<a class="code" href="classcesubmit_1_1Job.html#a72513b2a7d6889f795c45652cf2cfb8e">jobid</a> <span class="keywordflow">is</span> <span class="keywordtype">None</span>:
<a name="l00135"></a>00135             <span class="keywordflow">return</span>
<a name="l00136"></a>00136         log.debug(<span class="stringliteral">&quot;Canceling &quot;</span>+self.<a class="code" href="classcesubmit_1_1Job.html#a72513b2a7d6889f795c45652cf2cfb8e">jobid</a>)
<a name="l00137"></a>00137         command = [<span class="stringliteral">&quot;glite-ce-job-cancel&quot;</span>, <span class="stringliteral">&quot;--noint&quot;</span>, self.<a class="code" href="classcesubmit_1_1Job.html#a72513b2a7d6889f795c45652cf2cfb8e">jobid</a>]
<a name="l00138"></a>00138         process = subprocess.Popen(command, stdout=subprocess.PIPE)
<a name="l00139"></a>00139         stdout, stderr = process.communicate()
<a name="l00140"></a>00140         <span class="keywordflow">if</span> process.returncode!=0:
<a name="l00141"></a>00141             log.warning(<span class="stringliteral">&apos;Cancelling failed for job id &apos;</span>+self.<a class="code" href="classcesubmit_1_1Job.html#a72513b2a7d6889f795c45652cf2cfb8e">jobid</a>)
<a name="l00142"></a>00142         <span class="keywordflow">else</span>:
<a name="l00143"></a>00143             self.<a class="code" href="classcesubmit_1_1Job.html#ad55395950074fcee08e9ab68c63ffbc6">frontEndStatus</a> = <span class="stringliteral">&quot;CANCELLED&quot;</span>
<a name="l00144"></a><a class="code" href="classcesubmit_1_1Job.html#abae1efe849e60ec5654a0e3bcf8b53de">00144</a>     <span class="keyword">def </span><a class="code" href="classcesubmit_1_1Job.html#abae1efe849e60ec5654a0e3bcf8b53de">purge</a>(self):
<a name="l00145"></a>00145         <span class="keywordflow">if</span> self.<a class="code" href="classcesubmit_1_1Job.html#a72513b2a7d6889f795c45652cf2cfb8e">jobid</a> <span class="keywordflow">is</span> <span class="keywordtype">None</span>:
<a name="l00146"></a>00146             <span class="keywordflow">return</span>
<a name="l00147"></a>00147         log.debug(<span class="stringliteral">&quot;Purging &quot;</span>+self.<a class="code" href="classcesubmit_1_1Job.html#a72513b2a7d6889f795c45652cf2cfb8e">jobid</a>)
<a name="l00148"></a>00148         command = [<span class="stringliteral">&quot;glite-ce-job-purge&quot;</span>, <span class="stringliteral">&quot;--noint&quot;</span>, self.<a class="code" href="classcesubmit_1_1Job.html#a72513b2a7d6889f795c45652cf2cfb8e">jobid</a>]
<a name="l00149"></a>00149         process = subprocess.Popen(command, stdout=subprocess.PIPE)
<a name="l00150"></a>00150         stdout, stderr = process.communicate()
<a name="l00151"></a>00151         <span class="keywordflow">if</span> process.returncode!=0:
<a name="l00152"></a>00152             log.warning(<span class="stringliteral">&apos;Purging failed for job id &apos;</span>+self.<a class="code" href="classcesubmit_1_1Job.html#a72513b2a7d6889f795c45652cf2cfb8e">jobid</a>)
<a name="l00153"></a>00153         <span class="keywordflow">else</span>:
<a name="l00154"></a>00154             self.<a class="code" href="classcesubmit_1_1Job.html#ad55395950074fcee08e9ab68c63ffbc6">frontEndStatus</a> = <span class="stringliteral">&quot;PURGED&quot;</span>
<a name="l00155"></a><a class="code" href="classcesubmit_1_1Job.html#abd3c4bb8e309ec4f6075a70d0ff00540">00155</a>     <span class="keyword">def </span><a class="code" href="classcesubmit_1_1Job.html#abd3c4bb8e309ec4f6075a70d0ff00540">kill</a>(self):
<a name="l00156"></a>00156         self.<a class="code" href="classcesubmit_1_1Job.html#af6312c9aa24591f79db86d89b5e0ff6b">cancel</a>()
<a name="l00157"></a>00157         self.<a class="code" href="classcesubmit_1_1Job.html#abae1efe849e60ec5654a0e3bcf8b53de">purge</a>()
<a name="l00158"></a>00158         self.<a class="code" href="classcesubmit_1_1Job.html#a5d79f9e0207a1d688c2b8d780f3736e7">infos</a> = dict()
<a name="l00159"></a>00159 
<a name="l00160"></a><a class="code" href="classcesubmit_1_1Job.html#ac8fbbc656ca37f53ec024cd414863b1e">00160</a>     <span class="keyword">def </span><a class="code" href="classcesubmit_1_1Job.html#ac8fbbc656ca37f53ec024cd414863b1e">resubmit</a>(self):
<a name="l00161"></a>00161         <span class="keywordflow">if</span> self.<a class="code" href="classcesubmit_1_1Job.html#aab5365b3032f68465c8705e342caab45">status</a> <span class="keywordflow">in</span> [<span class="stringliteral">&quot;PENDING&quot;</span>, <span class="stringliteral">&quot;IDLE&quot;</span>, <span class="stringliteral">&quot;RUNNING&quot;</span>, <span class="stringliteral">&quot;REALLY-RUNNING&quot;</span>, <span class="stringliteral">&quot;HELD&quot;</span>]:
<a name="l00162"></a>00162             self.<a class="code" href="classcesubmit_1_1Job.html#af6312c9aa24591f79db86d89b5e0ff6b">cancel</a>()
<a name="l00163"></a>00163         self.<a class="code" href="classcesubmit_1_1Job.html#abae1efe849e60ec5654a0e3bcf8b53de">purge</a>()
<a name="l00164"></a>00164         self.<a class="code" href="classcesubmit_1_1Job.html#a5d79f9e0207a1d688c2b8d780f3736e7">infos</a> = dict()
<a name="l00165"></a>00165         self.<a class="code" href="classcesubmit_1_1Job.html#a687826fb1ad7266324287b5cb34da8b6">submit</a>()
<a name="l00166"></a>00166     @property
<a name="l00167"></a><a class="code" href="classcesubmit_1_1Job.html#aaf929c8eb269ea21126833b54abf19da">00167</a>     <span class="keyword">def </span><a class="code" href="classcesubmit_1_1Job.html#aaf929c8eb269ea21126833b54abf19da">outputSubDirectory</a>(self):
<a name="l00168"></a>00168         <span class="keywordflow">return</span> str(self.<a class="code" href="classcesubmit_1_1Job.html#a72513b2a7d6889f795c45652cf2cfb8e">jobid</a>).replace(<span class="stringliteral">&quot;https://&quot;</span>,<span class="stringliteral">&quot;&quot;</span>).replace(<span class="stringliteral">&quot;:&quot;</span>,<span class="stringliteral">&quot;_&quot;</span>).replace(<span class="stringliteral">&quot;/&quot;</span>,<span class="stringliteral">&quot;_&quot;</span>)
<a name="l00169"></a>00169 
<a name="l00170"></a>00170 
<a name="l00171"></a><a class="code" href="classcesubmit_1_1Task.html">00171</a> <span class="keyword">class </span><a class="code" href="classcesubmit_1_1Task.html">Task</a>:
<a name="l00172"></a>00172     @classmethod
<a name="l00173"></a><a class="code" href="classcesubmit_1_1Task.html#aba37de8e2705d2e8683c35930c11605d">00173</a>     <span class="keyword">def </span><a class="code" href="classcesubmit_1_1Task.html#aba37de8e2705d2e8683c35930c11605d">load</a>(cls, directory):
<a name="l00174"></a>00174         f = open(os.path.join(directory, <span class="stringliteral">&quot;task.pkl&quot;</span>),<span class="stringliteral">&apos;rb&apos;</span>)
<a name="l00175"></a>00175         obj = pickle.load(f)
<a name="l00176"></a>00176         f.close()
<a name="l00177"></a>00177         obj.directory = os.path.abspath(directory)
<a name="l00178"></a>00178         obj.mode = <span class="stringliteral">&quot;OPEN&quot;</span>
<a name="l00179"></a>00179         <span class="comment"># for downward compatibility with old task.pkl files. This can be removed in the future</span>
<a name="l00180"></a>00180         <span class="keywordflow">if</span> <span class="keywordflow">not</span> <span class="stringliteral">&apos;ceId&apos;</span> <span class="keywordflow">in</span> obj.__dict__:
<a name="l00181"></a>00181             obj.ceId = <span class="stringliteral">&apos;grid-ce.physik.rwth-aachen.de:8443/cream-pbs-cms&apos;</span>
<a name="l00182"></a>00182         <span class="keywordflow">return</span> obj
<a name="l00183"></a><a class="code" href="classcesubmit_1_1Task.html#a176f32374460cd2545e2aca0b27821fa">00183</a>     <span class="keyword">def </span><a class="code" href="classcesubmit_1_1Task.html#a176f32374460cd2545e2aca0b27821fa">__init__</a>(self, name, directory = None, mode=&quot;RECREATE&quot;, scramArch=&apos;slc5_amd64_gcc462&apos;, cmsswVersion=&apos;CMSSW_5_3_14&apos;, ceId=&apos;grid-ce.physik.rwth-aachen.de:8443/cream-pbs-cms<span class="stringliteral">&apos;):</span>
<a name="l00184"></a><a class="code" href="classcesubmit_1_1Task.html#aac7a584a42822a0ab22e76c97ea2440f">00184</a> <span class="stringliteral">        self.<a class="code" href="classcesubmit_1_1Task.html#aac7a584a42822a0ab22e76c97ea2440f">name</a> = name</span>
<a name="l00185"></a><a class="code" href="classcesubmit_1_1Task.html#a39dd968c0e59a04b55b039af44b6b635">00185</a> <span class="stringliteral">        self.<a class="code" href="classcesubmit_1_1Task.html#a39dd968c0e59a04b55b039af44b6b635">directory</a>=directory</span>
<a name="l00186"></a>00186 <span class="stringliteral">        </span><span class="keywordflow">if</span> self.<a class="code" href="classcesubmit_1_1Task.html#a39dd968c0e59a04b55b039af44b6b635">directory</a> <span class="keywordflow">is</span> <span class="keywordtype">None</span>:
<a name="l00187"></a>00187             self.<a class="code" href="classcesubmit_1_1Task.html#a39dd968c0e59a04b55b039af44b6b635">directory</a> = name
<a name="l00188"></a>00188         self.<a class="code" href="classcesubmit_1_1Task.html#a39dd968c0e59a04b55b039af44b6b635">directory</a> = os.path.abspath(self.<a class="code" href="classcesubmit_1_1Task.html#a39dd968c0e59a04b55b039af44b6b635">directory</a>)
<a name="l00189"></a><a class="code" href="classcesubmit_1_1Task.html#a5e1b00598899fce3b43e5640476684b4">00189</a>         self.<a class="code" href="classcesubmit_1_1Task.html#a5e1b00598899fce3b43e5640476684b4">jdlfilename</a> = name+<span class="stringliteral">&quot;.jdl&quot;</span>
<a name="l00190"></a><a class="code" href="classcesubmit_1_1Task.html#a75d919e385e7a498e514792f95058788">00190</a>         self.inputfiles, self.outputfiles, self.<a class="code" href="classcesubmit_1_1Task.html#a9ed60d40a066f34df3127ce0604b685a">jobs</a>, self.<a class="code" href="classcesubmit_1_1Task.html#a75d919e385e7a498e514792f95058788">executable</a> = [], [], [], <span class="keywordtype">None</span>
<a name="l00191"></a><a class="code" href="classcesubmit_1_1Task.html#afbfa8c0ad008d0685486541c92b2a531">00191</a>         self.<a class="code" href="classcesubmit_1_1Task.html#afbfa8c0ad008d0685486541c92b2a531">mode</a> = mode
<a name="l00192"></a><a class="code" href="classcesubmit_1_1Task.html#af7d7ffdf4d1da22f4e7200f782190bea">00192</a>         self.<a class="code" href="classcesubmit_1_1Task.html#af7d7ffdf4d1da22f4e7200f782190bea">scramArch</a> = scramArch
<a name="l00193"></a><a class="code" href="classcesubmit_1_1Task.html#a0562c10d0964ad50b129ecf646e5eb6f">00193</a>         self.<a class="code" href="classcesubmit_1_1Task.html#a0562c10d0964ad50b129ecf646e5eb6f">cmsswVersion</a> = cmsswVersion
<a name="l00194"></a><a class="code" href="classcesubmit_1_1Task.html#ad1a0c9a2316017e05ecec63f62dbd9f8">00194</a>         self.<a class="code" href="classcesubmit_1_1Task.html#ad1a0c9a2316017e05ecec63f62dbd9f8">ceId</a> = ceId
<a name="l00195"></a><a class="code" href="classcesubmit_1_1Task.html#a9ed60d40a066f34df3127ce0604b685a">00195</a>         self.<a class="code" href="classcesubmit_1_1Task.html#a9ed60d40a066f34df3127ce0604b685a">jobs</a> = []
<a name="l00196"></a><a class="code" href="classcesubmit_1_1Task.html#aa22ac5f0f6bfbd4854dfe63ae3007a2b">00196</a>         self.<a class="code" href="classcesubmit_1_1Task.html#aa22ac5f0f6bfbd4854dfe63ae3007a2b">frontEndStatus</a>=<span class="stringliteral">&quot;&quot;</span>
<a name="l00197"></a><a class="code" href="classcesubmit_1_1Task.html#af040ea9c4fd2fe12a4742e42d902622f">00197</a>     <span class="keyword">def </span><a class="code" href="classcesubmit_1_1Task.html#af040ea9c4fd2fe12a4742e42d902622f">save</a>(self):
<a name="l00198"></a>00198         log.debug(<span class="stringliteral">&apos;Save task %s&apos;</span>,self.<a class="code" href="classcesubmit_1_1Task.html#aac7a584a42822a0ab22e76c97ea2440f">name</a>)
<a name="l00199"></a>00199         f = open(os.path.join(self.<a class="code" href="classcesubmit_1_1Task.html#a39dd968c0e59a04b55b039af44b6b635">directory</a>, <span class="stringliteral">&quot;task.pkl&quot;</span>), <span class="stringliteral">&apos;wb&apos;</span>)
<a name="l00200"></a>00200         pickle.dump(self, f)
<a name="l00201"></a>00201         f.close()
<a name="l00202"></a>00202         f = open(os.path.join(self.<a class="code" href="classcesubmit_1_1Task.html#a39dd968c0e59a04b55b039af44b6b635">directory</a>, <span class="stringliteral">&quot;jobids.txt&quot;</span>), <span class="stringliteral">&apos;w&apos;</span>)
<a name="l00203"></a>00203         <span class="keywordflow">for</span> job <span class="keywordflow">in</span> self.<a class="code" href="classcesubmit_1_1Task.html#a9ed60d40a066f34df3127ce0604b685a">jobs</a>:
<a name="l00204"></a>00204             <span class="keywordflow">try</span>:
<a name="l00205"></a>00205                 f.write(str(job.jobid)+<span class="stringliteral">&quot;\n&quot;</span>)
<a name="l00206"></a>00206             <span class="keywordflow">except</span> (AttributeError, TypeError):
<a name="l00207"></a>00207                 f.write(<span class="stringliteral">&quot;None\n&quot;</span>)
<a name="l00208"></a>00208         f.close()
<a name="l00209"></a><a class="code" href="classcesubmit_1_1Task.html#ab224fdd4dbb448623b424eff422ac89b">00209</a>     <span class="keyword">def </span><a class="code" href="classcesubmit_1_1Task.html#ab224fdd4dbb448623b424eff422ac89b">addJob</a>(self, job):
<a name="l00210"></a>00210         job.task = self
<a name="l00211"></a>00211         self.<a class="code" href="classcesubmit_1_1Task.html#a9ed60d40a066f34df3127ce0604b685a">jobs</a>.append(job)
<a name="l00212"></a><a class="code" href="classcesubmit_1_1Task.html#a9754539b69e7da6962f5a4a857e540d4">00212</a>     <span class="keyword">def </span><a class="code" href="classcesubmit_1_1Task.html#a9754539b69e7da6962f5a4a857e540d4">submit</a>(self, processes=0):
<a name="l00213"></a>00213         log.debug(<span class="stringliteral">&apos;Submit task %s&apos;</span>,self.<a class="code" href="classcesubmit_1_1Task.html#aac7a584a42822a0ab22e76c97ea2440f">name</a>)
<a name="l00214"></a>00214         <span class="keywordflow">if</span> len(self.<a class="code" href="classcesubmit_1_1Task.html#a9ed60d40a066f34df3127ce0604b685a">jobs</a>)==0:
<a name="l00215"></a>00215             log.error(<span class="stringliteral">&apos;No jobs in task %s&apos;</span>,self.<a class="code" href="classcesubmit_1_1Task.html#aac7a584a42822a0ab22e76c97ea2440f">name</a>)
<a name="l00216"></a>00216             <span class="keywordflow">return</span>
<a name="l00217"></a>00217         <span class="comment"># create directory</span>
<a name="l00218"></a>00218         self.<a class="code" href="classcesubmit_1_1Task.html#a919f971f9806940a75b3b2d8b6eb950d">createdir</a>()
<a name="l00219"></a>00219         startdir = os.getcwd()
<a name="l00220"></a>00220         os.chdir(self.<a class="code" href="classcesubmit_1_1Task.html#a39dd968c0e59a04b55b039af44b6b635">directory</a>)
<a name="l00221"></a>00221         log.debug(<span class="stringliteral">&apos;Make prologue %s&apos;</span>,self.<a class="code" href="classcesubmit_1_1Task.html#aac7a584a42822a0ab22e76c97ea2440f">name</a>)
<a name="l00222"></a>00222         self.<a class="code" href="classcesubmit_1_1Task.html#ac5646c036479aeffdf642e6e1df4351a">makePrologue</a>()
<a name="l00223"></a>00223         checkAndRenewVomsProxy(604800)
<a name="l00224"></a>00224         <span class="comment">#enumerate jobs and create jdl files</span>
<a name="l00225"></a>00225         log.debug(<span class="stringliteral">&apos;Create %d jdl file&apos;</span>,len(self.<a class="code" href="classcesubmit_1_1Task.html#a9ed60d40a066f34df3127ce0604b685a">jobs</a>))
<a name="l00226"></a>00226         <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(len(self.<a class="code" href="classcesubmit_1_1Task.html#a9ed60d40a066f34df3127ce0604b685a">jobs</a>)):
<a name="l00227"></a>00227             self.<a class="code" href="classcesubmit_1_1Task.html#a9ed60d40a066f34df3127ce0604b685a">jobs</a>[i].nodeid = i
<a name="l00228"></a>00228             self.<a class="code" href="classcesubmit_1_1Task.html#a9ed60d40a066f34df3127ce0604b685a">jobs</a>[i].writeJdl()
<a name="l00229"></a>00229         <span class="comment">#multiprocessing</span>
<a name="l00230"></a>00230         self.<a class="code" href="classcesubmit_1_1Task.html#ade263fe8f1a88a24977f75dcd2e5cc92">_dosubmit</a>(range(len(self.<a class="code" href="classcesubmit_1_1Task.html#a9ed60d40a066f34df3127ce0604b685a">jobs</a>)), processes, submitWorker)
<a name="l00231"></a>00231         self.<a class="code" href="classcesubmit_1_1Task.html#aa22ac5f0f6bfbd4854dfe63ae3007a2b">frontEndStatus</a>=<span class="stringliteral">&quot;SUBMITTED&quot;</span>
<a name="l00232"></a>00232         os.chdir(startdir)
<a name="l00233"></a>00233         <span class="comment">#print self.jobs[0].__dict__</span>
<a name="l00234"></a>00234         self.<a class="code" href="classcesubmit_1_1Task.html#af040ea9c4fd2fe12a4742e42d902622f">save</a>()
<a name="l00235"></a><a class="code" href="classcesubmit_1_1Task.html#ade263fe8f1a88a24977f75dcd2e5cc92">00235</a>     <span class="keyword">def </span><a class="code" href="classcesubmit_1_1Task.html#ade263fe8f1a88a24977f75dcd2e5cc92">_dosubmit</a>(self, nodeids, processes, worker):
<a name="l00236"></a>00236         jobs = [j <span class="keywordflow">for</span> j <span class="keywordflow">in</span> self.<a class="code" href="classcesubmit_1_1Task.html#a9ed60d40a066f34df3127ce0604b685a">jobs</a> <span class="keywordflow">if</span> j.nodeid <span class="keywordflow">in</span> nodeids]
<a name="l00237"></a>00237         <span class="keywordflow">if</span> processes:
<a name="l00238"></a>00238             pool = multiprocessing.Pool(processes)
<a name="l00239"></a>00239             result = pool.map_async(worker, jobs)
<a name="l00240"></a>00240             pool.close()
<a name="l00241"></a>00241             <span class="comment">#pool.join()</span>
<a name="l00242"></a>00242             <span class="keywordflow">while</span> pool._cache:
<a name="l00243"></a>00243                 time.sleep(1)
<a name="l00244"></a>00244             res = result.get()
<a name="l00245"></a>00245             <span class="keywordflow">for</span> job <span class="keywordflow">in</span> res:  <span class="comment">#because the task and jobs have been pickled, the references have to be restored</span>
<a name="l00246"></a>00246                 job.task = self
<a name="l00247"></a>00247                 self.<a class="code" href="classcesubmit_1_1Task.html#a9ed60d40a066f34df3127ce0604b685a">jobs</a>[job.nodeid]=job
<a name="l00248"></a>00248         <span class="keywordflow">else</span>:
<a name="l00249"></a>00249             <span class="keywordflow">for</span> job <span class="keywordflow">in</span> jobs:
<a name="l00250"></a>00250                 worker(job)
<a name="l00251"></a>00251 
<a name="l00252"></a><a class="code" href="classcesubmit_1_1Task.html#a9336c9efdcc993670f14b7f7a54fcb80">00252</a>     <span class="keyword">def </span><a class="code" href="classcesubmit_1_1Task.html#a9336c9efdcc993670f14b7f7a54fcb80">resubmit</a>(self, nodeids, processes=0):
<a name="l00253"></a>00253         <span class="keywordflow">if</span> len(nodeids)==0: <span class="keywordflow">return</span>
<a name="l00254"></a>00254         log.debug(<span class="stringliteral">&apos;Resubmit (some) jobs of task %s&apos;</span>,self.<a class="code" href="classcesubmit_1_1Task.html#aac7a584a42822a0ab22e76c97ea2440f">name</a>)
<a name="l00255"></a>00255         self.<a class="code" href="classcesubmit_1_1Task.html#ade263fe8f1a88a24977f75dcd2e5cc92">_dosubmit</a>(nodeids, processes, resubmitWorker)
<a name="l00256"></a>00256         self.<a class="code" href="classcesubmit_1_1Task.html#aa22ac5f0f6bfbd4854dfe63ae3007a2b">frontEndStatus</a> = <span class="stringliteral">&quot;SUBMITTED&quot;</span>
<a name="l00257"></a>00257         self.<a class="code" href="classcesubmit_1_1Task.html#af040ea9c4fd2fe12a4742e42d902622f">save</a>()
<a name="l00258"></a>00258         self.<a class="code" href="classcesubmit_1_1Task.html#a4c1b7271d341aff9653e1c4939156322">cleanUp</a>()
<a name="l00259"></a><a class="code" href="classcesubmit_1_1Task.html#af5dbf18ec19d94e970b5d0170e18baa1">00259</a>     <span class="keyword">def </span><a class="code" href="classcesubmit_1_1Task.html#af5dbf18ec19d94e970b5d0170e18baa1">kill</a>(self, nodeids, processes=0):
<a name="l00260"></a>00260         log.debug(<span class="stringliteral">&apos;Kill (some) jobs of task %s&apos;</span>,self.<a class="code" href="classcesubmit_1_1Task.html#aac7a584a42822a0ab22e76c97ea2440f">name</a>)
<a name="l00261"></a>00261         self.<a class="code" href="classcesubmit_1_1Task.html#ade263fe8f1a88a24977f75dcd2e5cc92">_dosubmit</a>(nodeids, processes, killWorker)
<a name="l00262"></a>00262         self.<a class="code" href="classcesubmit_1_1Task.html#af040ea9c4fd2fe12a4742e42d902622f">save</a>()
<a name="l00263"></a>00263         self.<a class="code" href="classcesubmit_1_1Task.html#a4c1b7271d341aff9653e1c4939156322">cleanUp</a>()
<a name="l00264"></a>00264             
<a name="l00265"></a><a class="code" href="classcesubmit_1_1Task.html#ac5646c036479aeffdf642e6e1df4351a">00265</a>     <span class="keyword">def </span><a class="code" href="classcesubmit_1_1Task.html#ac5646c036479aeffdf642e6e1df4351a">makePrologue</a>(self):
<a name="l00266"></a>00266         executable = (
<a name="l00267"></a>00267         <span class="stringliteral">&apos;#!/bin/sh -e\n&apos;</span>
<a name="l00268"></a>00268         +<span class="stringliteral">&apos;echo Job started: $(date)\n&apos;</span>
<a name="l00269"></a>00269         +<span class="stringliteral">&apos;chmod u+x $1\n&apos;</span>
<a name="l00270"></a>00270         +<span class="stringliteral">&apos;RUNAREA=$(pwd)\n&apos;</span>
<a name="l00271"></a>00271         +<span class="stringliteral">&apos;echo Running in: $RUNAREA\n&apos;</span>
<a name="l00272"></a>00272         +<span class="stringliteral">&apos;echo Running on: $HOSTNAME\n&apos;</span>
<a name="l00273"></a>00273         )
<a name="l00274"></a>00274         <span class="keywordflow">if</span> self.<a class="code" href="classcesubmit_1_1Task.html#a0562c10d0964ad50b129ecf646e5eb6f">cmsswVersion</a> <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>:
<a name="l00275"></a>00275             executable += (
<a name="l00276"></a>00276             <span class="stringliteral">&apos;echo Setting SCRAM_ARCH to &apos;</span> + self.<a class="code" href="classcesubmit_1_1Task.html#af7d7ffdf4d1da22f4e7200f782190bea">scramArch</a> +<span class="stringliteral">&apos;\n&apos;</span>
<a name="l00277"></a>00277             +<span class="stringliteral">&apos;export SCRAM_ARCH=&apos;</span> +self.<a class="code" href="classcesubmit_1_1Task.html#af7d7ffdf4d1da22f4e7200f782190bea">scramArch</a> + <span class="stringliteral">&apos;\n&apos;</span>
<a name="l00278"></a>00278             +<span class="stringliteral">&apos;export BUILD_ARCH=$SCRAM_ARCH\n&apos;</span>
<a name="l00279"></a>00279             +<span class="stringliteral">&apos;source $VO_CMS_SW_DIR/cmsset_default.sh\n&apos;</span>
<a name="l00280"></a>00280             +<span class="stringliteral">&apos;scram project CMSSW &apos;</span> + self.<a class="code" href="classcesubmit_1_1Task.html#a0562c10d0964ad50b129ecf646e5eb6f">cmsswVersion</a> + <span class="stringliteral">&apos;\n&apos;</span>
<a name="l00281"></a>00281             +<span class="stringliteral">&apos;cd &apos;</span> + self.<a class="code" href="classcesubmit_1_1Task.html#a0562c10d0964ad50b129ecf646e5eb6f">cmsswVersion</a> + <span class="stringliteral">&apos;\n&apos;</span>
<a name="l00282"></a>00282             +<span class="stringliteral">&apos;eval $(scramv1 ru -sh)\n&apos;</span>
<a name="l00283"></a>00283             +<span class="stringliteral">&apos;cd $RUNAREA\n&apos;</span>
<a name="l00284"></a>00284             )
<a name="l00285"></a>00285         executable += (
<a name="l00286"></a>00286         <span class="stringliteral">&apos;env\n&apos;</span>
<a name="l00287"></a>00287         +<span class="stringliteral">&apos;echo Current directory $PWD\n&apos;</span>
<a name="l00288"></a>00288         +<span class="stringliteral">&apos;echo Directory content:\n&apos;</span>
<a name="l00289"></a>00289         +<span class="stringliteral">&apos;ls\n&apos;</span>
<a name="l00290"></a>00290         +<span class="stringliteral">&apos;$@\n&apos;</span>
<a name="l00291"></a>00291         +<span class="stringliteral">&apos;echo Current directory $PWD\n&apos;</span>
<a name="l00292"></a>00292         +<span class="stringliteral">&apos;echo Directory content:\n&apos;</span>
<a name="l00293"></a>00293         +<span class="stringliteral">&apos;ls\n&apos;</span>
<a name="l00294"></a>00294         +<span class="stringliteral">&apos;echo Job ended: $(date)\n&apos;</span>
<a name="l00295"></a>00295         )
<a name="l00296"></a>00296         f = open(<span class="stringliteral">&quot;prologue.sh&quot;</span>,<span class="stringliteral">&quot;w&quot;</span>)
<a name="l00297"></a>00297         f.write(executable)
<a name="l00298"></a>00298         f.close()
<a name="l00299"></a><a class="code" href="classcesubmit_1_1Task.html#a919f971f9806940a75b3b2d8b6eb950d">00299</a>     <span class="keyword">def </span><a class="code" href="classcesubmit_1_1Task.html#a919f971f9806940a75b3b2d8b6eb950d">createdir</a>(self):
<a name="l00300"></a>00300         <span class="keywordflow">if</span> os.path.exists(self.<a class="code" href="classcesubmit_1_1Task.html#a39dd968c0e59a04b55b039af44b6b635">directory</a>) <span class="keywordflow">and</span> self.<a class="code" href="classcesubmit_1_1Task.html#afbfa8c0ad008d0685486541c92b2a531">mode</a>!=<span class="stringliteral">&quot;RECREATE&quot;</span>:
<a name="l00301"></a>00301             <span class="keywordflow">raise</span> Exception(<span class="stringliteral">&apos;Directory &apos;</span> + self.<a class="code" href="classcesubmit_1_1Task.html#a39dd968c0e59a04b55b039af44b6b635">directory</a> + <span class="stringliteral">&apos;already exists&apos;</span>)
<a name="l00302"></a>00302         <span class="keywordflow">elif</span> os.path.exists(self.<a class="code" href="classcesubmit_1_1Task.html#a39dd968c0e59a04b55b039af44b6b635">directory</a>):
<a name="l00303"></a>00303             shutil.rmtree(self.<a class="code" href="classcesubmit_1_1Task.html#a39dd968c0e59a04b55b039af44b6b635">directory</a>)
<a name="l00304"></a>00304         os.makedirs(self.<a class="code" href="classcesubmit_1_1Task.html#a39dd968c0e59a04b55b039af44b6b635">directory</a>)
<a name="l00305"></a><a class="code" href="classcesubmit_1_1Task.html#a245a18c82b4b32e4fec03f009e80bc3a">00305</a>     <span class="keyword">def </span><a class="code" href="classcesubmit_1_1Task.html#a245a18c82b4b32e4fec03f009e80bc3a">_getStatusMultiple</a>(self):
<a name="l00306"></a>00306         jobs = [job <span class="keywordflow">for</span> job <span class="keywordflow">in</span> self.<a class="code" href="classcesubmit_1_1Task.html#a9ed60d40a066f34df3127ce0604b685a">jobs</a> <span class="keywordflow">if</span> job.frontEndStatus <span class="keywordflow">not</span> <span class="keywordflow">in</span> [<span class="stringliteral">&quot;RETRIEVED&quot;</span>, <span class="stringliteral">&quot;PURGED&quot;</span>]]
<a name="l00307"></a>00307         jobids = [job.jobid <span class="keywordflow">for</span> job <span class="keywordflow">in</span> jobs <span class="keywordflow">if</span> job.jobid <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>]
<a name="l00308"></a>00308         <span class="keywordflow">if</span> <span class="keywordflow">not</span> jobids: <span class="keywordflow">return</span> 0
<a name="l00309"></a>00309         command = [<span class="stringliteral">&quot;glite-ce-job-status&quot;</span>, <span class="stringliteral">&quot;-L1&quot;</span>] + jobids
<a name="l00310"></a>00310         process = subprocess.Popen(command, stdout=subprocess.PIPE)
<a name="l00311"></a>00311         stdout, stderr = process.communicate()
<a name="l00312"></a>00312         <span class="keywordflow">if</span> process.returncode!=0:
<a name="l00313"></a>00313             log.warning(<span class="stringliteral">&apos;Status retrieval failed for task &apos;</span>+self.<a class="code" href="classcesubmit_1_1Task.html#aac7a584a42822a0ab22e76c97ea2440f">name</a>)
<a name="l00314"></a>00314             log.info(stdout)
<a name="l00315"></a>00315             log.info(stderr)
<a name="l00316"></a>00316         result = parseStatusMultipleL1(stdout)
<a name="l00317"></a>00317         <span class="keywordflow">for</span> job <span class="keywordflow">in</span> jobs:
<a name="l00318"></a>00318             <span class="keywordflow">try</span>:
<a name="l00319"></a>00319                 infos = result[job.jobid]
<a name="l00320"></a>00320                 <span class="keywordflow">if</span> len(infos)&gt;0:
<a name="l00321"></a>00321                     job.infos = infos
<a name="l00322"></a>00322                 <span class="keywordflow">else</span>:
<a name="l00323"></a>00323                     log.warning(<span class="stringliteral">&apos;Failed to get status of job %s of task %s&apos;</span>,job.jobid, self.<a class="code" href="classcesubmit_1_1Task.html#aac7a584a42822a0ab22e76c97ea2440f">name</a>)
<a name="l00324"></a>00324             <span class="keywordflow">except</span> KeyError:
<a name="l00325"></a>00325                 log.warning(<span class="stringliteral">&apos;Failed to get status of job %s of task %s&apos;</span>,job.jobid, self.<a class="code" href="classcesubmit_1_1Task.html#aac7a584a42822a0ab22e76c97ea2440f">name</a>)
<a name="l00326"></a>00326         <span class="keywordflow">return</span> len(jobids)
<a name="l00327"></a><a class="code" href="classcesubmit_1_1Task.html#a9ca184a36fa60cc4a64da2abfbe0d3bf">00327</a>     <span class="keyword">def </span><a class="code" href="classcesubmit_1_1Task.html#a9ca184a36fa60cc4a64da2abfbe0d3bf">getStatus</a>(self):
<a name="l00328"></a>00328         log.debug(<span class="stringliteral">&apos;Get status of task %s&apos;</span>,self.<a class="code" href="classcesubmit_1_1Task.html#aac7a584a42822a0ab22e76c97ea2440f">name</a>)
<a name="l00329"></a>00329         numberOfJobs = self.<a class="code" href="classcesubmit_1_1Task.html#a245a18c82b4b32e4fec03f009e80bc3a">_getStatusMultiple</a>()
<a name="l00330"></a>00330         oldfestatus = self.<a class="code" href="classcesubmit_1_1Task.html#aa22ac5f0f6bfbd4854dfe63ae3007a2b">frontEndStatus</a>
<a name="l00331"></a>00331         retrieved, done, running, purged = <span class="keyword">True</span>, <span class="keyword">True</span>, <span class="keyword">False</span>, <span class="keyword">True</span>
<a name="l00332"></a>00332         <span class="keywordflow">for</span> job <span class="keywordflow">in</span> self.<a class="code" href="classcesubmit_1_1Task.html#a9ed60d40a066f34df3127ce0604b685a">jobs</a>:
<a name="l00333"></a>00333             <span class="keywordflow">if</span> job.frontEndStatus!=<span class="stringliteral">&quot;RETRIEVED&quot;</span>:
<a name="l00334"></a>00334                 retrieved=<span class="keyword">False</span>
<a name="l00335"></a>00335             <span class="keywordflow">if</span> job.frontEndStatus!=<span class="stringliteral">&quot;PURGED&quot;</span>:
<a name="l00336"></a>00336                 purged = <span class="keyword">False</span>
<a name="l00337"></a>00337             <span class="keywordflow">if</span> <span class="stringliteral">&quot;RUNNING&quot;</span> <span class="keywordflow">in</span> job.status:
<a name="l00338"></a>00338                 running=<span class="keyword">True</span>
<a name="l00339"></a>00339                 <span class="keywordflow">break</span>
<a name="l00340"></a>00340             <span class="keywordflow">if</span> <span class="stringliteral">&quot;DONE&quot;</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> job.status:
<a name="l00341"></a>00341                 done = <span class="keyword">False</span>
<a name="l00342"></a>00342         <span class="keywordflow">if</span> running: self.<a class="code" href="classcesubmit_1_1Task.html#aa22ac5f0f6bfbd4854dfe63ae3007a2b">frontEndStatus</a>=<span class="stringliteral">&quot;RUNNING&quot;</span>
<a name="l00343"></a>00343         <span class="keywordflow">elif</span> retrieved: self.<a class="code" href="classcesubmit_1_1Task.html#aa22ac5f0f6bfbd4854dfe63ae3007a2b">frontEndStatus</a>=<span class="stringliteral">&quot;RETRIEVED&quot;</span>
<a name="l00344"></a>00344         <span class="keywordflow">elif</span> done: self.<a class="code" href="classcesubmit_1_1Task.html#aa22ac5f0f6bfbd4854dfe63ae3007a2b">frontEndStatus</a>=<span class="stringliteral">&quot;DONE&quot;</span>
<a name="l00345"></a>00345         <span class="keywordflow">elif</span> purged: self.<a class="code" href="classcesubmit_1_1Task.html#aa22ac5f0f6bfbd4854dfe63ae3007a2b">frontEndStatus</a>=<span class="stringliteral">&quot;PURGED&quot;</span>
<a name="l00346"></a>00346         <span class="keywordflow">if</span> numberOfJobs &gt; 0 <span class="keywordflow">or</span> oldfestatus != self.<a class="code" href="classcesubmit_1_1Task.html#aa22ac5f0f6bfbd4854dfe63ae3007a2b">frontEndStatus</a>:
<a name="l00347"></a>00347             self.<a class="code" href="classcesubmit_1_1Task.html#af040ea9c4fd2fe12a4742e42d902622f">save</a>()
<a name="l00348"></a>00348         <span class="keywordflow">return</span> self.<a class="code" href="classcesubmit_1_1Task.html#aa22ac5f0f6bfbd4854dfe63ae3007a2b">frontEndStatus</a>
<a name="l00349"></a>00349 
<a name="l00350"></a><a class="code" href="classcesubmit_1_1Task.html#a6d1b6bc54bede96b37144350b1378655">00350</a>     <span class="keyword">def </span><a class="code" href="classcesubmit_1_1Task.html#a6d1b6bc54bede96b37144350b1378655">getOutput</a>(self, connections=1):
<a name="l00351"></a>00351         jobs = [job <span class="keywordflow">for</span> job <span class="keywordflow">in</span> self.<a class="code" href="classcesubmit_1_1Task.html#a9ed60d40a066f34df3127ce0604b685a">jobs</a> <span class="keywordflow">if</span> job.status==<span class="stringliteral">&quot;DONE-OK&quot;</span> <span class="keywordflow">and</span> job.frontEndStatus <span class="keywordflow">not</span> <span class="keywordflow">in</span> [<span class="stringliteral">&quot;RETRIEVED&quot;</span>, <span class="stringliteral">&quot;PURGED&quot;</span>]]
<a name="l00352"></a>00352         <span class="keywordflow">if</span> <span class="keywordflow">not</span> jobs: <span class="keywordflow">return</span>
<a name="l00353"></a>00353         jobpackages = list(chunks(jobs, 100))
<a name="l00354"></a>00354         log.info(<span class="stringliteral">&apos;Get output of %s jobs of task %s&apos;</span>,str(len(jobs)), self.<a class="code" href="classcesubmit_1_1Task.html#aac7a584a42822a0ab22e76c97ea2440f">name</a>)
<a name="l00355"></a>00355         <span class="keywordflow">for</span> jobpackage <span class="keywordflow">in</span> jobpackages:
<a name="l00356"></a>00356             jobids = [job.jobid <span class="keywordflow">for</span> job <span class="keywordflow">in</span> jobpackage <span class="keywordflow">if</span> job.jobid <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>]
<a name="l00357"></a>00357             command = [<span class="stringliteral">&quot;glite-ce-job-output&quot;</span>, <span class="stringliteral">&quot;-s&quot;</span>, str(connections), <span class="stringliteral">&quot;--noint&quot;</span>, <span class="stringliteral">&quot;--dir&quot;</span>, self.<a class="code" href="classcesubmit_1_1Task.html#a39dd968c0e59a04b55b039af44b6b635">directory</a>] + jobids
<a name="l00358"></a>00358             process = subprocess.Popen(command, stdout=subprocess.PIPE)
<a name="l00359"></a>00359             stdout, stderr = process.communicate()
<a name="l00360"></a>00360             <span class="keywordflow">if</span> process.returncode!=0:
<a name="l00361"></a>00361                 log.warning(<span class="stringliteral">&apos;Output retrieval failed for task &apos;</span>+self.<a class="code" href="classcesubmit_1_1Task.html#aac7a584a42822a0ab22e76c97ea2440f">name</a>)
<a name="l00362"></a>00362                 log.info(stdout)
<a name="l00363"></a>00363                 log.info(stderr)
<a name="l00364"></a>00364             <span class="keywordflow">else</span>:
<a name="l00365"></a>00365                 succesfulljobids = parseGetOutput(stdout)
<a name="l00366"></a>00366                 log.info(<span class="stringliteral">&apos;Tried to retrieved %s jobs&apos;</span>, str(len(succesfulljobids)))
<a name="l00367"></a>00367                 <span class="keywordflow">for</span> job <span class="keywordflow">in</span> jobpackage:
<a name="l00368"></a>00368                     <span class="keywordflow">if</span> job.jobid <span class="keywordflow">in</span> succesfulljobids:
<a name="l00369"></a>00369                         job.purge()
<a name="l00370"></a>00370                         job.frontEndStatus = <span class="stringliteral">&quot;RETRIEVED&quot;</span>
<a name="l00371"></a>00371                         log.debug(<span class="stringliteral">&apos;Successfully retrieved job %s&apos;</span>, job.jobid)
<a name="l00372"></a>00372                     <span class="keywordflow">else</span>:
<a name="l00373"></a>00373                         job.frontEndStatus = <span class="stringliteral">&quot;FAILED2RETRIEVE&quot;</span>
<a name="l00374"></a>00374                         log.warning(<span class="stringliteral">&apos;Failed to retrieve job %s&apos;</span>, job.jobid)
<a name="l00375"></a>00375         self.<a class="code" href="classcesubmit_1_1Task.html#af040ea9c4fd2fe12a4742e42d902622f">save</a>()
<a name="l00376"></a>00376 
<a name="l00377"></a><a class="code" href="classcesubmit_1_1Task.html#af089aabf5cd1a6b20f62ba2430da19ea">00377</a>     <span class="keyword">def </span><a class="code" href="classcesubmit_1_1Task.html#af089aabf5cd1a6b20f62ba2430da19ea">jobStatusNumbers</a>(self):
<a name="l00378"></a>00378         jobStatusNumbers=defaultdict(int)
<a name="l00379"></a>00379         good, bad = 0, 0
<a name="l00380"></a>00380         <span class="keywordflow">for</span> job <span class="keywordflow">in</span> self.<a class="code" href="classcesubmit_1_1Task.html#a9ed60d40a066f34df3127ce0604b685a">jobs</a>:
<a name="l00381"></a>00381             <span class="keywordflow">try</span>:
<a name="l00382"></a>00382                 jobStatusNumbers[job.status]+=1
<a name="l00383"></a>00383                 jobStatusNumbers[job.frontEndStatus]+=1
<a name="l00384"></a>00384                 <span class="keywordflow">if</span> job.status <span class="keywordflow">in</span> [<span class="stringliteral">&quot;ABORTED&quot;</span>, <span class="stringliteral">&quot;DONE-FAILED&quot;</span>]:
<a name="l00385"></a>00385                     bad += 1
<a name="l00386"></a>00386                 <span class="keywordflow">if</span> job.status == <span class="stringliteral">&quot;DONE-OK&quot;</span>:
<a name="l00387"></a>00387                     <span class="keywordflow">if</span> <span class="stringliteral">&quot;ExitCode&quot;</span> <span class="keywordflow">in</span> job.infos:
<a name="l00388"></a>00388                         <span class="keywordflow">if</span> job.infos[<span class="stringliteral">&quot;ExitCode&quot;</span>] == <span class="stringliteral">&quot;0&quot;</span>:
<a name="l00389"></a>00389                             good += 1
<a name="l00390"></a>00390                         <span class="keywordflow">else</span>:
<a name="l00391"></a>00391                             bad += 1
<a name="l00392"></a>00392             <span class="keywordflow">except</span> AttributeError:
<a name="l00393"></a>00393                 <span class="keywordflow">pass</span>
<a name="l00394"></a>00394         jobStatusNumbers[<span class="stringliteral">&quot;total&quot;</span>]=len(self.<a class="code" href="classcesubmit_1_1Task.html#a9ed60d40a066f34df3127ce0604b685a">jobs</a>)
<a name="l00395"></a>00395         jobStatusNumbers[<span class="stringliteral">&quot;good&quot;</span>] = good
<a name="l00396"></a>00396         jobStatusNumbers[<span class="stringliteral">&quot;bad&quot;</span>] = bad
<a name="l00397"></a>00397         <span class="keywordflow">return</span> jobStatusNumbers
<a name="l00398"></a><a class="code" href="classcesubmit_1_1Task.html#a4c1b7271d341aff9653e1c4939156322">00398</a>     <span class="keyword">def </span><a class="code" href="classcesubmit_1_1Task.html#a4c1b7271d341aff9653e1c4939156322">cleanUp</a>(self):
<a name="l00399"></a>00399         log.debug(<span class="stringliteral">&apos;Cleaning up task %s&apos;</span>,self.<a class="code" href="classcesubmit_1_1Task.html#aac7a584a42822a0ab22e76c97ea2440f">name</a>)
<a name="l00400"></a>00400         subdirs=[job.outputSubDirectory <span class="keywordflow">for</span> job <span class="keywordflow">in</span> self.<a class="code" href="classcesubmit_1_1Task.html#a9ed60d40a066f34df3127ce0604b685a">jobs</a> <span class="keywordflow">if</span> job.jobid <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>]
<a name="l00401"></a>00401         <span class="keywordflow">for</span> checkdir <span class="keywordflow">in</span> glob.glob(os.path.join(self.<a class="code" href="classcesubmit_1_1Task.html#a39dd968c0e59a04b55b039af44b6b635">directory</a>,<span class="stringliteral">&quot;*&quot;</span>)):
<a name="l00402"></a>00402             <span class="keywordflow">if</span> os.path.isdir(checkdir) <span class="keywordflow">and</span> os.path.basename(checkdir)!=<span class="stringliteral">&quot;bak&quot;</span>:
<a name="l00403"></a>00403                 <span class="keywordflow">if</span> os.path.basename(checkdir) <span class="keywordflow">not</span> <span class="keywordflow">in</span> subdirs:
<a name="l00404"></a>00404                     <span class="keywordflow">try</span>:
<a name="l00405"></a>00405                         os.mkdir(os.path.join(self.<a class="code" href="classcesubmit_1_1Task.html#a39dd968c0e59a04b55b039af44b6b635">directory</a>,<span class="stringliteral">&quot;bak&quot;</span>))
<a name="l00406"></a>00406                     <span class="keywordflow">except</span> OSError:
<a name="l00407"></a>00407                         <span class="keywordflow">pass</span>
<a name="l00408"></a>00408                     shutil.move(checkdir, os.path.join(self.<a class="code" href="classcesubmit_1_1Task.html#a39dd968c0e59a04b55b039af44b6b635">directory</a>, <span class="stringliteral">&quot;bak&quot;</span>))
<a name="l00409"></a>00409 
<a name="l00410"></a>00410 
<a name="l00411"></a>00411         
<a name="l00412"></a><a class="code" href="namespacecesubmit.html#a956e885a5e514e7d107f8992c7b836f5">00412</a> <span class="keyword">def </span><a class="code" href="namespacecesubmit.html#a956e885a5e514e7d107f8992c7b836f5">parseGetOutput</a>(stdout):
<a name="l00413"></a>00413     successfuljobidlist=[]
<a name="l00414"></a>00414     <span class="keywordflow">for</span> line <span class="keywordflow">in</span> stdout.splitlines():
<a name="l00415"></a>00415         <span class="keywordflow">if</span> <span class="stringliteral">&quot;https&quot;</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> line: <span class="keywordflow">continue</span>
<a name="l00416"></a>00416         regex = re.compile(<span class="stringliteral">&quot;\[(https.*?)\]&quot;</span>)
<a name="l00417"></a>00417         r = regex.search(line)
<a name="l00418"></a>00418         <span class="keywordflow">try</span>:
<a name="l00419"></a>00419             jobid = r.groups()[0]
<a name="l00420"></a>00420         <span class="keywordflow">except</span> IndexError:
<a name="l00421"></a>00421             <span class="keywordflow">continue</span>
<a name="l00422"></a>00422         <span class="keywordflow">if</span> <span class="stringliteral">&quot;output will be stored&quot;</span> <span class="keywordflow">in</span> line:
<a name="l00423"></a>00423             successfuljobidlist.append(jobid)
<a name="l00424"></a>00424     <span class="keywordflow">return</span> successfuljobidlist
<a name="l00425"></a>00425 
<a name="l00426"></a><a class="code" href="namespacecesubmit.html#a6463e2c0a5601cbc38128e20538ad785">00426</a> <span class="keyword">def </span><a class="code" href="namespacecesubmit.html#a6463e2c0a5601cbc38128e20538ad785">parseStatus</a>(stdout):
<a name="l00427"></a>00427     <span class="comment"># parses the output of glite-ce-job-status to a dict</span>
<a name="l00428"></a>00428     result=dict()
<a name="l00429"></a>00429     <span class="keywordflow">for</span> line <span class="keywordflow">in</span> stdout.splitlines():
<a name="l00430"></a>00430         <span class="keywordflow">try</span>:
<a name="l00431"></a>00431             key, value = line.split(<span class="stringliteral">&quot;=&quot;</span>,1)
<a name="l00432"></a>00432         <span class="keywordflow">except</span> ValueError:
<a name="l00433"></a>00433             <span class="keywordflow">continue</span>
<a name="l00434"></a>00434         key, value = key.strip(<span class="stringliteral">&quot;\t* &quot;</span>), value.strip()[1:-1]
<a name="l00435"></a>00435         result[key] = value
<a name="l00436"></a>00436     <span class="keywordflow">return</span> result
<a name="l00437"></a>00437 
<a name="l00438"></a><a class="code" href="namespacecesubmit.html#ac3ece630953438311bb841f67cd1c852">00438</a> <span class="keyword">def </span><a class="code" href="namespacecesubmit.html#ac3ece630953438311bb841f67cd1c852">parseStatusMultiple</a>(stdout):
<a name="l00439"></a>00439     <span class="comment"># parses the output of glite-ce-job-status to a dict for multiple jobids</span>
<a name="l00440"></a>00440     result = dict()
<a name="l00441"></a>00441     jobid = <span class="keywordtype">None</span>
<a name="l00442"></a>00442     <span class="keywordflow">for</span> line <span class="keywordflow">in</span> stdout.splitlines():
<a name="l00443"></a>00443         <span class="keywordflow">try</span>:
<a name="l00444"></a>00444             key, value = line.split(<span class="stringliteral">&quot;=&quot;</span>,1)
<a name="l00445"></a>00445         <span class="keywordflow">except</span> ValueError:
<a name="l00446"></a>00446             <span class="keywordflow">continue</span>
<a name="l00447"></a>00447         key, value = key.strip(<span class="stringliteral">&quot;\t* &quot;</span>), value.strip()[1:-1]
<a name="l00448"></a>00448         <span class="keywordflow">if</span> key==<span class="stringliteral">&quot;JobID&quot;</span>:
<a name="l00449"></a>00449             jobid = value
<a name="l00450"></a>00450             result[jobid]=dict()
<a name="l00451"></a>00451         result[jobid][key] = value
<a name="l00452"></a>00452     <span class="keywordflow">return</span> result
<a name="l00453"></a>00453 
<a name="l00454"></a><a class="code" href="namespacecesubmit.html#a5643dd6e22a340df9ceca52ec6f6d2b3">00454</a> <span class="keyword">def </span><a class="code" href="namespacecesubmit.html#a5643dd6e22a340df9ceca52ec6f6d2b3">parseStatusMultipleL1</a>(stdout):
<a name="l00455"></a>00455     <span class="comment"># parses the output of glite-ce-job-status -L1 to a dict, this includes the status history</span>
<a name="l00456"></a>00456     result = dict()
<a name="l00457"></a>00457     jobid = <span class="keywordtype">None</span>
<a name="l00458"></a>00458     <span class="keywordflow">for</span> line <span class="keywordflow">in</span> stdout.splitlines():
<a name="l00459"></a>00459         <span class="keywordflow">try</span>:
<a name="l00460"></a>00460             key, value = line.split(<span class="stringliteral">&quot;=&quot;</span>,1)
<a name="l00461"></a>00461         <span class="keywordflow">except</span> ValueError:
<a name="l00462"></a>00462             <span class="keywordflow">continue</span>
<a name="l00463"></a>00463         <span class="keywordflow">if</span> <span class="stringliteral">&quot;Command&quot;</span> <span class="keywordflow">in</span> key: <span class="keywordflow">continue</span>
<a name="l00464"></a>00464         key, value = key.strip(<span class="stringliteral">&quot;\t* &quot;</span>), value.strip()[1:-1]
<a name="l00465"></a>00465         <span class="keywordflow">if</span> key==<span class="stringliteral">&quot;JobID&quot;</span>:
<a name="l00466"></a>00466             jobid = value
<a name="l00467"></a>00467             result[jobid]=dict()
<a name="l00468"></a>00468             result[jobid][<span class="stringliteral">&quot;history&quot;</span>]=list()
<a name="l00469"></a>00469         <span class="keywordflow">if</span> key==<span class="stringliteral">&quot;Status&quot;</span>:
<a name="l00470"></a>00470             status=value.split()[0][0:-1]
<a name="l00471"></a>00471             timestamp=value.split()[-1][1:]
<a name="l00472"></a>00472             result[jobid][<span class="stringliteral">&quot;history&quot;</span>].append( (status, timestamp,) )
<a name="l00473"></a>00473             result[jobid][<span class="stringliteral">&quot;Status&quot;</span>] = status
<a name="l00474"></a>00474         <span class="keywordflow">else</span>:
<a name="l00475"></a>00475             result[jobid][key] = value
<a name="l00476"></a>00476     <span class="keywordflow">return</span> result
<a name="l00477"></a>00477 
<a name="l00478"></a><a class="code" href="namespacecesubmit.html#aefab1ddfabc21cfd9788543b6270fbba">00478</a> <span class="keyword">def </span><a class="code" href="namespacecesubmit.html#aefab1ddfabc21cfd9788543b6270fbba">chunks</a>(l, n):
<a name="l00479"></a>00479     <span class="stringliteral">&quot;&quot;&quot; Yield successive n-sized chunks from l.</span>
<a name="l00480"></a>00480 <span class="stringliteral">    &quot;&quot;&quot;</span>
<a name="l00481"></a>00481     <span class="keywordflow">for</span> i <span class="keywordflow">in</span> xrange(0, len(l), n):
<a name="l00482"></a>00482         <span class="keywordflow">yield</span> l[i:i+n]
<a name="l00483"></a>00483 
<a name="l00484"></a><a class="code" href="classcesubmit_1_1ProxyError.html">00484</a> <span class="keyword">class </span><a class="code" href="classcesubmit_1_1ProxyError.html">ProxyError</a>( Exception ):
<a name="l00485"></a>00485     <span class="keywordflow">pass</span>
<a name="l00486"></a>00486 
<a name="l00487"></a><a class="code" href="namespacecesubmit.html#a76541afc0335964e2044c1ae09565b77">00487</a> <span class="keyword">def </span><a class="code" href="namespacecesubmit.html#a76541afc0335964e2044c1ae09565b77">timeLeftVomsProxy</a>():
<a name="l00488"></a>00488     log.debug(<span class="stringliteral">&apos;Check time left of VomsProxy&apos;</span>)
<a name="l00489"></a>00489     <span class="stringliteral">&quot;&quot;&quot;Return the time left for the proxy.&quot;&quot;&quot;</span>
<a name="l00490"></a>00490     proc = subprocess.Popen( [<span class="stringliteral">&apos;voms-proxy-info&apos;</span>, <span class="stringliteral">&apos;-timeleft&apos;</span> ], stdout=subprocess.PIPE, stderr=subprocess.STDOUT )
<a name="l00491"></a>00491     output = proc.communicate()[0]
<a name="l00492"></a>00492     log.debug(<span class="stringliteral">&apos;Check time left of VomsProxy [Done]&apos;</span>)
<a name="l00493"></a>00493     <span class="keywordflow">if</span> proc.returncode != 0:
<a name="l00494"></a>00494         <span class="keywordflow">return</span> <span class="keyword">False</span>
<a name="l00495"></a>00495     <span class="keywordflow">else</span>:
<a name="l00496"></a>00496         <span class="keywordflow">return</span> int( output )
<a name="l00497"></a>00497 
<a name="l00498"></a><a class="code" href="namespacecesubmit.html#af386af64ed3723450be730835c96495b">00498</a> <span class="keyword">def </span><a class="code" href="namespacecesubmit.html#af386af64ed3723450be730835c96495b">checkVomsProxy</a>( time=86400 ):
<a name="l00499"></a>00499     <span class="stringliteral">&quot;&quot;&quot;Returns True if the proxy is valid longer than time, False otherwise.&quot;&quot;&quot;</span>
<a name="l00500"></a>00500     timeleft = timeLeftVomsProxy()
<a name="l00501"></a>00501     <span class="keywordflow">return</span> timeleft &gt; time
<a name="l00502"></a>00502 
<a name="l00503"></a><a class="code" href="namespacecesubmit.html#a02091e7e82d4c658bc9b614ad42645f5">00503</a> <span class="keyword">def </span><a class="code" href="namespacecesubmit.html#a02091e7e82d4c658bc9b614ad42645f5">renewVomsProxy</a>( voms=&apos;cms:/cms/dcms<span class="stringliteral">&apos;, passphrase=None ):</span>
<a name="l00504"></a>00504 <span class="stringliteral">    </span><span class="stringliteral">&quot;&quot;&quot;Make a new proxy with a lifetime of one week.&quot;&quot;&quot;</span>
<a name="l00505"></a>00505     <span class="keywordflow">if</span> passphrase:
<a name="l00506"></a>00506         p = subprocess.Popen([<span class="stringliteral">&apos;voms-proxy-init&apos;</span>, <span class="stringliteral">&apos;--voms&apos;</span>, voms, <span class="stringliteral">&apos;--valid&apos;</span>, <span class="stringliteral">&apos;192:00&apos;</span>], stdout=subprocess.PIPE, stdin=subprocess.PIPE, stderr=subprocess.STDOUT)
<a name="l00507"></a>00507         stdout = p.communicate(input=passphrase+<span class="stringliteral">&apos;\n&apos;</span>)[0]
<a name="l00508"></a>00508         retcode = p.returncode
<a name="l00509"></a>00509         <span class="keywordflow">if</span> <span class="keywordflow">not</span> retcode == 0:
<a name="l00510"></a>00510             <span class="keywordflow">raise</span> ProxyError( <span class="stringliteral">&apos;Proxy initialization command failed: &apos;</span>+stdout )
<a name="l00511"></a>00511     <span class="keywordflow">else</span>:
<a name="l00512"></a>00512         retcode = subprocess.call( [<span class="stringliteral">&apos;voms-proxy-init&apos;</span>, <span class="stringliteral">&apos;--voms&apos;</span>, voms, <span class="stringliteral">&apos;--valid&apos;</span>, <span class="stringliteral">&apos;192:00&apos;</span>] )
<a name="l00513"></a>00513     <span class="keywordflow">if</span> <span class="keywordflow">not</span> retcode == 0:
<a name="l00514"></a>00514         <span class="keywordflow">raise</span> ProxyError( <span class="stringliteral">&apos;Proxy initialization command failed.&apos;</span>)
<a name="l00515"></a>00515 
<a name="l00516"></a><a class="code" href="namespacecesubmit.html#addc6c2825dfae9d95ca22d4a3fa4697e">00516</a> <span class="keyword">def </span><a class="code" href="namespacecesubmit.html#addc6c2825dfae9d95ca22d4a3fa4697e">checkAndRenewVomsProxy</a>( time=604800, voms=&apos;cms:/cms/dcms<span class="stringliteral">&apos;, passphrase=None ):</span>
<a name="l00517"></a>00517 <span class="stringliteral">    log.debug(</span><span class="stringliteral">&apos;Check and renew VomsProxy&apos;</span>)
<a name="l00518"></a>00518     <span class="stringliteral">&quot;&quot;&quot;Check if the proxy is valid longer than time and renew if needed.&quot;&quot;&quot;</span>
<a name="l00519"></a>00519     <span class="keywordflow">if</span> <span class="keywordflow">not</span> checkVomsProxy( time ):
<a name="l00520"></a>00520         renewVomsProxy(passphrase=passphrase)
<a name="l00521"></a>00521         <span class="keywordflow">if</span> <span class="keywordflow">not</span> checkVomsProxy( time ):
<a name="l00522"></a>00522             <span class="keywordflow">raise</span> ProxyError( <span class="stringliteral">&apos;Proxy still not valid long enough!&apos;</span> )
<a name="l00523"></a>00523     log.debug(<span class="stringliteral">&apos;Check and renew VomsProxy [Done]&apos;</span>)
</pre></div></div>
<!-- HTML footer for doxygen 1.8.5-->
<!-- start footer part -->
<!--BEGIN GENERATE_TREEVIEW-->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    $navpath
    <li class="footer">
      libs3a is part of TAPAS check out all parts of it on 
      <a href="https://github.com/Aachen-3A/TAPAS">github</a>.
      Documentation $generatedby
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="$relpath^doxygen.png" alt="doxygen"/></a> 1.6.1 </li>
  </ul>

</div>
<!--END GENERATE_TREEVIEW-->
<!--BEGIN !GENERATE_TREEVIEW-->
<hr class="footer"/><address class="footer"><small>

$generatedby &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="$relpath^doxygen.png" alt="doxygen"/>
</a> 1.6.1
</small></address>
<!--END !GENERATE_TREEVIEW-->
</body>
</html>
