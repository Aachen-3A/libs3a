<!-- HTML header for doxygen 1.8.5-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.6.1"/>
<!--BEGIN PROJECT_NAME--><title>libs3a: libs3a: python/dbconfigmanager.py Source File</title><!--END PROJECT_NAME-->
<!--BEGIN !PROJECT_NAME--><title>libs3a: python/dbconfigmanager.py Source File</title><!--END !PROJECT_NAME-->
<link href="$relpath^tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="$relpath^jquery.js"></script>
<script type="text/javascript" src="$relpath^dynsections.js"></script>
$treeview
$search
$mathjax
<link href="$relpath^$stylesheet" rel="stylesheet" type="text/css" />
$extrastylesheet
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->

<!--BEGIN TITLEAREA-->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <!--BEGIN PROJECT_LOGO-->
  <td id="projectlogo"><img alt="Logo" src="$relpath^$projectlogo"/></td>
  <!--END PROJECT_LOGO-->
  <!--BEGIN PROJECT_NAME-->
  <td style="padding-left: 0.5em;">
   <div id="projectname">libs3a
   <!--BEGIN PROJECT_NUMBER-->&#160;<span id="projectnumber"></span><!--END PROJECT_NUMBER-->
   </div>
   <!--BEGIN PROJECT_BRIEF--><div id="projectbrief">$projectbrief</div><!--END PROJECT_BRIEF-->
  </td>
  <!--END PROJECT_NAME-->
  <!--BEGIN !PROJECT_NAME-->
   <!--BEGIN PROJECT_BRIEF-->
    <td style="padding-left: 0.5em;">
    <div id="projectbrief">$projectbrief</div>
    </td>
   <!--END PROJECT_BRIEF-->
  <!--END !PROJECT_NAME-->
  <!--BEGIN DISABLE_INDEX-->
   <!--BEGIN SEARCHENGINE-->
   <td>$searchbox</td>
   <!--END SEARCHENGINE-->
  <!--END DISABLE_INDEX-->
    <td style="padding-left: 20.5em;">
      <div> Choose your branch:</div>
  </td>
  <td style="padding-left: .5em;">
      <div align=right><select id="choose_branch">
        <option value="">Change branch</option>
        <option value="http://aachen-3a.github.io/libs3a/doc/doc_master/html/index.html">master</option>
<option value="http://aachen-3a.github.io/libs3a/doc/doc_dev/html/index.html">dev</option>
        </select>
     </div>   
    <script>
        document.getElementById("choose_branch").onchange = function() {
                if (this.selectedIndex!==0) {
                            window.location.href = this.value;
                            //window.open( this.value ); 
                }        
            };
    </script>
  </td>
  <td style="padding-left: 15.5em;">
      <div> Get back to <a href="https://github.com/Aachen-3A/libs3a">GitHub</a></div>
  </td> 
  <td style="padding-left: 0.2em;">
      <div> or </div>
  </td> 
  <td style="padding-left: 0.2em;">
      <div> <a href="https://github.com/Aachen-3A/TAPAS">TAPAS main page</a></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!--END TITLEAREA-->
<!-- end header part -->
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
<h1>python/dbconfigmanager.py</h1><a href="dbconfigmanager_8py.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a><a class="code" href="namespacedbconfigmanager.html">00001</a> <span class="comment">#!/usr/bin/python</span>
<a name="l00002"></a>00002 <span class="comment">#</span>
<a name="l00003"></a>00003 <span class="comment"># Copyright [2015] - &lt;Markus Radziej&gt;</span>
<a name="l00004"></a>00004 
<a name="l00005"></a>00005 <span class="comment">## @package dbconfigmanager</span>
<a name="l00006"></a>00006 <span class="comment"># Tool to manage config files of samples stored in a database</span>
<a name="l00007"></a>00007 <span class="comment">#</span>
<a name="l00008"></a>00008 <span class="comment"># This is a tool to manage cross sections, number of events and weights for</span>
<a name="l00009"></a>00009 <span class="comment"># various samples, which are stored in the aix3adb database. Upon creating the</span>
<a name="l00010"></a>00010 <span class="comment"># DBConfigManager object, one sets a working directory in which the xsv123.cfg</span>
<a name="l00011"></a>00011 <span class="comment"># files are stored. To sync a list of samples with the database, one has to pass</span>
<a name="l00012"></a>00012 <span class="comment"># it to update_config function. The tool then takes the provided config file or</span>
<a name="l00013"></a>00013 <span class="comment"># the latest revision it can find in the working directory and compares its</span>
<a name="l00014"></a>00014 <span class="comment"># entries with the ones stored in the database.</span>
<a name="l00015"></a>00015 <span class="comment">#</span>
<a name="l00016"></a>00016 <span class="comment"># Example usage</span>
<a name="l00017"></a>00017 <span class="comment">#</span>
<a name="l00018"></a>00018 <span class="comment"># Create the object and pass the working directory as an argument</span>
<a name="l00019"></a>00019 <span class="comment"># import dbconfigmanager</span>
<a name="l00020"></a>00020 <span class="comment"># cfgmgr = dbconfigmanager.DBConfigManager(&quot;../cfg/xs/&quot;)</span>
<a name="l00021"></a>00021 <span class="comment">#</span>
<a name="l00022"></a>00022 <span class="comment"># Read a specific config file</span>
<a name="l00023"></a>00023 <span class="comment"># cfgmgr.read_config(&quot;../cfg/xs/xsv300.cfg&quot;)</span>
<a name="l00024"></a>00024 <span class="comment">#</span>
<a name="l00025"></a>00025 <span class="comment"># Update the loaded or a specific config with a list of samples</span>
<a name="l00026"></a>00026 <span class="comment"># update_succesful = cfgmgr.update_config([&quot;blub&quot;])</span>
<a name="l00027"></a>00027 <span class="comment"># update_succesful = cfgmgr.update_config([&quot;blub&quot;], &quot;../cfg/xs/xsv300.cfg&quot;)</span>
<a name="l00028"></a>00028 <span class="comment">#</span>
<a name="l00029"></a>00029 <span class="comment"># Instead of frequently querying the database, one can use auto_update. This</span>
<a name="l00030"></a>00030 <span class="comment"># will only perform a query, if the latest revision is older than the second</span>
<a name="l00031"></a>00031 <span class="comment"># argument (24 hours in this example).</span>
<a name="l00032"></a>00032 <span class="comment"># cfgmgr.auto_update([&quot;blub&quot;], 24)</span>
<a name="l00033"></a>00033 <span class="comment">#</span>
<a name="l00034"></a>00034 <span class="comment"># Retrieving the read python config</span>
<a name="l00035"></a>00035 <span class="comment"># cfgmgr.get_config()</span>
<a name="l00036"></a>00036 
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 <span class="keyword">import</span> sys
<a name="l00039"></a>00039 <span class="keyword">import</span> os
<a name="l00040"></a>00040 
<a name="l00041"></a>00041 <span class="keyword">import</span> logging
<a name="l00042"></a>00042 <span class="keyword">import</span> ConfigParser
<a name="l00043"></a>00043 <span class="keyword">import</span> datetime
<a name="l00044"></a>00044 
<a name="l00045"></a>00045 <span class="keyword">import</span> aix3adb
<a name="l00046"></a>00046 
<a name="l00047"></a>00047 <span class="comment">## Logger object</span>
<a name="l00048"></a><a class="code" href="namespacedbconfigmanager.html#a2f5d9e7a802f269ab59337f46d703b0a">00048</a> log = logging.getLogger(<span class="stringliteral">&quot;dbconfigmanager&quot;</span>)
<a name="l00049"></a>00049 
<a name="l00050"></a>00050 <span class="comment">## Database config manager class</span>
<a name="l00051"></a>00051 <span class="comment">#</span>
<a name="l00052"></a>00052 <span class="comment"># The database config manager is a tool to compare sample entries in a database</span>
<a name="l00053"></a>00053 <span class="comment"># with a local config file. It can update the contents of said file and write</span>
<a name="l00054"></a>00054 <span class="comment"># them to a new revision, meaning that no information is lost.</span>
<a name="l00055"></a><a class="code" href="classdbconfigmanager_1_1DBConfigManager.html">00055</a> <span class="keyword">class </span><a class="code" href="classdbconfigmanager_1_1DBConfigManager.html" title="Database config manager class.">DBConfigManager</a>:
<a name="l00056"></a>00056     <span class="comment">## Initialization method</span>
<a name="l00057"></a>00057     <span class="comment">#</span>
<a name="l00058"></a>00058     <span class="comment"># Can be used to set up the working directory by passing it as an argument.</span>
<a name="l00059"></a>00059     <span class="comment">#</span>
<a name="l00060"></a>00060     <span class="comment"># @param self The object pointer.</span>
<a name="l00061"></a>00061     <span class="comment"># @param directory_path The path to the working directory.</span>
<a name="l00062"></a><a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#ad21b8d71e5ce6bb73c3f5f83dca4e0d4">00062</a>     <span class="keyword">def </span><a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#ad21b8d71e5ce6bb73c3f5f83dca4e0d4" title="Initialization method.">__init__</a>(self, directory_path=&quot;../cfg/xs/&quot;):
<a name="l00063"></a>00063         <span class="comment"># set config file directory</span>
<a name="l00064"></a>00064         <span class="comment">## @var directory</span>
<a name="l00065"></a>00065         <span class="comment"># Working directory of the config manager</span>
<a name="l00066"></a><a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#aa0c4e2ec37b4da80aa8d3482618da2d7">00066</a>         self.<a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#aa0c4e2ec37b4da80aa8d3482618da2d7" title="Working directory of the config manager.">directory</a> = os.path.abspath(directory_path)
<a name="l00067"></a>00067         <span class="comment">## @var config</span>
<a name="l00068"></a>00068         <span class="comment"># Config object that is being worked on after reading</span>
<a name="l00069"></a><a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#a5c492abee663988219107c8052843055">00069</a>         self.<a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#a5c492abee663988219107c8052843055" title="Config object that is being worked on after reading.">config</a> = ConfigParser.SafeConfigParser()
<a name="l00070"></a>00070         <span class="comment">## @var aix3adb</span>
<a name="l00071"></a>00071         <span class="comment"># Aix3adb database object</span>
<a name="l00072"></a><a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#a86881b75866800fa47a75c930e4ea30b">00072</a>         self.<a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#a86881b75866800fa47a75c930e4ea30b" title="Aix3adb database object.">aix3adb</a> = aix3adb.aix3adb()
<a name="l00073"></a>00073 
<a name="l00074"></a>00074     <span class="comment">## Set the working directory of the DBConfigManager</span>
<a name="l00075"></a>00075     <span class="comment">#</span>
<a name="l00076"></a>00076     <span class="comment"># @param self The object pointer.</span>
<a name="l00077"></a>00077     <span class="comment"># @param directory_path The path to the working directory.</span>
<a name="l00078"></a><a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#a790799abc5743dace54931081368905a">00078</a>     <span class="keyword">def </span><a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#a790799abc5743dace54931081368905a" title="Set the working directory of the DBConfigManager.">set_directory</a>(self, directory_path):
<a name="l00079"></a>00079         <span class="stringliteral">&quot;&quot;&quot;Set the working directory of the config manager.&quot;&quot;&quot;</span>
<a name="l00080"></a>00080 
<a name="l00081"></a>00081         self.<a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#aa0c4e2ec37b4da80aa8d3482618da2d7" title="Working directory of the config manager.">directory</a> = directory_path
<a name="l00082"></a>00082 
<a name="l00083"></a>00083     <span class="comment">## Returns the latest revision of the config files named &apos;xsv123.cfg&apos;</span>
<a name="l00084"></a>00084     <span class="comment">#</span>
<a name="l00085"></a>00085     <span class="comment"># Checks the working directory for the xsv123.cfg file with the highest</span>
<a name="l00086"></a>00086     <span class="comment"># number and returns that number</span>
<a name="l00087"></a>00087     <span class="comment">#</span>
<a name="l00088"></a>00088     <span class="comment"># @return Latest config file revision number</span>
<a name="l00089"></a><a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#a46dc3b580b589e3a82ed82bcad8e64d5">00089</a>     <span class="keyword">def </span><a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#a46dc3b580b589e3a82ed82bcad8e64d5" title="Returns the latest revision of the config files named &amp;#39;xsv123.cfg&amp;#39;.">latest_revision</a>(self):
<a name="l00090"></a>00090         <span class="stringliteral">&quot;&quot;&quot;Returns the latest revision of the config files named &apos;xsv123.cfg&apos;.&quot;&quot;&quot;</span>
<a name="l00091"></a>00091 
<a name="l00092"></a>00092         <span class="comment"># get all _files_ in directory</span>
<a name="l00093"></a>00093         files = []
<a name="l00094"></a>00094          <span class="keywordflow">for</span> (dirpath, dirnames, filenames) <span class="keywordflow">in</span> os.walk(self.<a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#aa0c4e2ec37b4da80aa8d3482618da2d7" title="Working directory of the config manager.">directory</a>):
<a name="l00095"></a>00095             files.extend(filenames)
<a name="l00096"></a>00096             <span class="keywordflow">break</span>
<a name="l00097"></a>00097 
<a name="l00098"></a>00098         <span class="comment"># reduce the file names to the numeric portion</span>
<a name="l00099"></a>00099         file_numbers = []
<a name="l00100"></a>00100         <span class="keywordflow">for</span> f <span class="keywordflow">in</span> files:
<a name="l00101"></a>00101             f = f.rsplit(<span class="stringliteral">&quot;.&quot;</span>)[0]
<a name="l00102"></a>00102             file_numbers.append(int(f.replace(<span class="stringliteral">&quot;xsv&quot;</span>, <span class="stringliteral">&quot;&quot;</span>)))
<a name="l00103"></a>00103 
<a name="l00104"></a>00104         <span class="comment"># return last element / latest revision</span>
<a name="l00105"></a>00105         <span class="keywordflow">return</span> sorted(file_numbers)[-1] <span class="keywordflow">if</span> file_numbers <span class="keywordflow">else</span> <span class="keywordtype">None</span>
<a name="l00106"></a>00106 
<a name="l00107"></a>00107 
<a name="l00108"></a>00108     <span class="comment">## Returns the file name of the latest revision of config files named &apos;xsv123.cfg&apos;</span>
<a name="l00109"></a>00109     <span class="comment">#</span>
<a name="l00110"></a>00110     <span class="comment"># @param self The object pointer</span>
<a name="l00111"></a>00111     <span class="comment"># @return File name of the latest revision of config files</span>
<a name="l00112"></a><a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#abf46e88daad57c022a3ade9c16968bdd">00112</a>     <span class="keyword">def </span><a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#abf46e88daad57c022a3ade9c16968bdd" title="Returns the file name of the latest revision of config files named &amp;#39;xsv123.cfg&amp;#39;...">latest_file</a>(self):
<a name="l00113"></a>00113         <span class="keywordflow">return</span> <span class="stringliteral">&quot;xsv&quot;</span> + str(self.<a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#a46dc3b580b589e3a82ed82bcad8e64d5" title="Returns the latest revision of the config files named &amp;#39;xsv123.cfg&amp;#39;.">latest_revision</a>()) + <span class="stringliteral">&quot;.cfg&quot;</span>
<a name="l00114"></a>00114 
<a name="l00115"></a>00115 
<a name="l00116"></a>00116     <span class="comment">## Returns the path to the file corresponding to latest_revision()</span>
<a name="l00117"></a>00117     <span class="comment">#</span>
<a name="l00118"></a>00118     <span class="comment"># @param self The object pointer</span>
<a name="l00119"></a>00119     <span class="comment"># @return Absolute path to latest revision of config file</span>
<a name="l00120"></a><a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#ad674a86a9007a3d29c98a532af0c59e1">00120</a>     <span class="keyword">def </span><a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#ad674a86a9007a3d29c98a532af0c59e1" title="Returns the path to the file corresponding to latest_revision().">latest_abs_file</a>(self):
<a name="l00121"></a>00121         <span class="keywordflow">return</span> self.<a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#aa0c4e2ec37b4da80aa8d3482618da2d7" title="Working directory of the config manager.">directory</a> + <span class="stringliteral">&quot;/&quot;</span> + self.<a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#abf46e88daad57c022a3ade9c16968bdd" title="Returns the file name of the latest revision of config files named &amp;#39;xsv123.cfg&amp;#39;...">latest_file</a>()
<a name="l00122"></a>00122 
<a name="l00123"></a>00123     
<a name="l00124"></a>00124     <span class="comment">## Compares sample values with database entry</span>
<a name="l00125"></a>00125     <span class="comment">#</span>
<a name="l00126"></a>00126     <span class="comment"># Returns true if sample values are up to date, else false Returns the</span>
<a name="l00127"></a>00127     <span class="comment"># absolut path to the latest revision of config files</span>
<a name="l00128"></a>00128     <span class="comment">#</span>
<a name="l00129"></a>00129     <span class="comment"># @param self The object pointer</span>
<a name="l00130"></a>00130     <span class="comment"># @param sample Sample which is being compared</span>
<a name="l00131"></a>00131     <span class="comment"># @return True if sample is up to date, else False</span>
<a name="l00132"></a><a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#a515c625559081e827ce5aaba14e84287">00132</a>     <span class="keyword">def </span><a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#a515c625559081e827ce5aaba14e84287" title="Compares sample values with database entry.">compare_sample</a>(self, sample):
<a name="l00133"></a>00133         <span class="keywordflow">try</span>:
<a name="l00134"></a>00134             skimid = self.<a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#a5c492abee663988219107c8052843055" title="Config object that is being worked on after reading.">config</a>.getint(sample, <span class="stringliteral">&quot;id&quot;</span>) <span class="keywordflow">if</span> self.<a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#a5c492abee663988219107c8052843055" title="Config object that is being worked on after reading.">config</a>.has_option(sample, <span class="stringliteral">&quot;id&quot;</span>) <span class="keywordflow">else</span> <span class="keywordtype">None</span>
<a name="l00135"></a>00135             db_skim, db_sample = self.<a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#a86881b75866800fa47a75c930e4ea30b" title="Aix3adb database object.">aix3adb</a>.getMCSkimAndSample(sample, skimid)
<a name="l00136"></a>00136         <span class="keywordflow">except</span> aix3adb.Aix3adbException:
<a name="l00137"></a>00137             log.error(<span class="stringliteral">&quot;Sample &apos;&quot;</span> + sample + <span class="stringliteral">&quot;&apos; could not be found in the database. It has been removed from the config.&quot;</span>)
<a name="l00138"></a>00138             <span class="comment"># if sample is not in the database and not in the config,</span>
<a name="l00139"></a>00139             <span class="comment"># the config is considered up to date</span>
<a name="l00140"></a>00140             <span class="keywordflow">return</span> <span class="keywordflow">not</span> self.<a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#a5c492abee663988219107c8052843055" title="Config object that is being worked on after reading.">config</a>.remove_section(sample)
<a name="l00141"></a>00141 
<a name="l00142"></a>00142         up_to_date = <span class="keyword">True</span>
<a name="l00143"></a>00143         <span class="comment"># update section</span>
<a name="l00144"></a>00144         <span class="keywordflow">if</span> <span class="keywordflow">not</span> self.<a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#a5c492abee663988219107c8052843055" title="Config object that is being worked on after reading.">config</a>.has_section(sample):
<a name="l00145"></a>00145             log.info(<span class="stringliteral">&quot;Created new section for sample &apos;&quot;</span> + sample + <span class="stringliteral">&quot;&apos;.&quot;</span>)
<a name="l00146"></a>00146             up_to_date = <span class="keyword">False</span>
<a name="l00147"></a>00147             self.<a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#a5c492abee663988219107c8052843055" title="Config object that is being worked on after reading.">config</a>.add_section(sample)
<a name="l00148"></a>00148             self.<a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#a5c492abee663988219107c8052843055" title="Config object that is being worked on after reading.">config</a>.set(sample, <span class="stringliteral">&quot;nevents&quot;</span>, <span class="stringliteral">&quot;0&quot;</span>)
<a name="l00149"></a>00149             self.<a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#a5c492abee663988219107c8052843055" title="Config object that is being worked on after reading.">config</a>.set(sample, <span class="stringliteral">&quot;weight&quot;</span>, <span class="stringliteral">&quot;0.0&quot;</span>)
<a name="l00150"></a>00150             self.<a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#a5c492abee663988219107c8052843055" title="Config object that is being worked on after reading.">config</a>.set(sample, <span class="stringliteral">&quot;crosssection&quot;</span>, <span class="stringliteral">&quot;0.0&quot;</span>)
<a name="l00151"></a>00151 
<a name="l00152"></a>00152 
<a name="l00153"></a>00153         <span class="comment"># update crosssection</span>
<a name="l00154"></a>00154         crosssection = self.<a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#a5c492abee663988219107c8052843055" title="Config object that is being worked on after reading.">config</a>.getfloat(sample, <span class="stringliteral">&quot;crosssection&quot;</span>)
<a name="l00155"></a>00155         db_crosssection = float(db_sample.crosssection)
<a name="l00156"></a>00156         <span class="keywordflow">if</span> <span class="keywordflow">not</span> crosssection  == db_crosssection:
<a name="l00157"></a>00157             log.info(sample
<a name="l00158"></a>00158                      + <span class="stringliteral">&quot; [Crosssection] Old &quot;</span> + str(crosssection)
<a name="l00159"></a>00159                      + <span class="stringliteral">&quot; -- &gt;&gt;NEW&lt;&lt; &quot;</span> + str(db_crosssection))
<a name="l00160"></a>00160             up_to_date = <span class="keyword">False</span>
<a name="l00161"></a>00161             self.<a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#a5c492abee663988219107c8052843055" title="Config object that is being worked on after reading.">config</a>.set(sample, <span class="stringliteral">&quot;crosssection&quot;</span>, str(db_crosssection))
<a name="l00162"></a>00162 
<a name="l00163"></a>00163         <span class="comment"># update weight</span>
<a name="l00164"></a>00164         <span class="comment"># CAREFUL: composition of k-factor and filter efficiency</span>
<a name="l00165"></a>00165         weight = self.<a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#a5c492abee663988219107c8052843055" title="Config object that is being worked on after reading.">config</a>.getfloat(sample, <span class="stringliteral">&quot;weight&quot;</span>)
<a name="l00166"></a>00166         db_weight = float(db_sample.kfactor) * float(db_sample.filterefficiency)
<a name="l00167"></a>00167         <span class="keywordflow">if</span> <span class="keywordflow">not</span> weight == db_weight:
<a name="l00168"></a>00168             log.info(sample
<a name="l00169"></a>00169                      + <span class="stringliteral">&quot; [Weight] Old &quot;</span> + str(weight)
<a name="l00170"></a>00170                      + <span class="stringliteral">&quot; -- &gt;&gt;NEW&lt;&lt; &quot;</span> + str(db_weight))
<a name="l00171"></a>00171             up_to_date = <span class="keyword">False</span>
<a name="l00172"></a>00172             self.<a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#a5c492abee663988219107c8052843055" title="Config object that is being worked on after reading.">config</a>.set(sample, <span class="stringliteral">&quot;weight&quot;</span>, str(db_weight))
<a name="l00173"></a>00173 
<a name="l00174"></a>00174         <span class="comment"># update nevents</span>
<a name="l00175"></a>00175         nevents = self.<a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#a5c492abee663988219107c8052843055" title="Config object that is being worked on after reading.">config</a>.getint(sample, <span class="stringliteral">&quot;nevents&quot;</span>)
<a name="l00176"></a>00176         db_nevents = int(db_skim.nevents)
<a name="l00177"></a>00177         <span class="keywordflow">if</span> <span class="keywordflow">not</span> nevents == db_nevents:
<a name="l00178"></a>00178             log.info(sample +
<a name="l00179"></a>00179                      <span class="stringliteral">&quot; [NEvents] Old &quot;</span> + str(nevents)
<a name="l00180"></a>00180                      + <span class="stringliteral">&quot; -- &gt;&gt;NEW&lt;&lt; &quot;</span> + str(db_nevents))
<a name="l00181"></a>00181             up_to_date = <span class="keyword">False</span>
<a name="l00182"></a>00182             self.<a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#a5c492abee663988219107c8052843055" title="Config object that is being worked on after reading.">config</a>.set(sample, <span class="stringliteral">&quot;nevents&quot;</span>, str(db_nevents))
<a name="l00183"></a>00183 
<a name="l00184"></a>00184         <span class="keywordflow">return</span> up_to_date
<a name="l00185"></a>00185 
<a name="l00186"></a>00186     <span class="comment">## Reads the given config_file into the class variable self.config</span>
<a name="l00187"></a>00187     <span class="comment">#</span>
<a name="l00188"></a>00188     <span class="comment"># If no config_file is given, the latest revision of config files is being</span>
<a name="l00189"></a>00189     <span class="comment"># read.</span>
<a name="l00190"></a>00190     <span class="comment">#</span>
<a name="l00191"></a>00191     <span class="comment"># @param self The object pointer</span>
<a name="l00192"></a>00192     <span class="comment"># @param config_file Path to a config file to be read. Optional.</span>
<a name="l00193"></a><a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#ac89ecf7e79e524b16e400450c0e6b8da">00193</a>     <span class="keyword">def </span><a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#ac89ecf7e79e524b16e400450c0e6b8da" title="Reads the given config_file into the class variable self.config.">read_config</a>(self, config_file = None):
<a name="l00194"></a>00194         <span class="comment"># if no config_file is given, try to fill default value</span>
<a name="l00195"></a>00195         <span class="keywordflow">if</span> config_file <span class="keywordflow">is</span> <span class="keywordtype">None</span>:
<a name="l00196"></a>00196             <span class="comment"># replace with latest revision (if there is one)</span>
<a name="l00197"></a>00197             rev = self.<a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#a46dc3b580b589e3a82ed82bcad8e64d5" title="Returns the latest revision of the config files named &amp;#39;xsv123.cfg&amp;#39;.">latest_revision</a>()
<a name="l00198"></a>00198             <span class="keywordflow">if</span> <span class="keywordflow">not</span> rev <span class="keywordflow">is</span> <span class="keywordtype">None</span>:
<a name="l00199"></a>00199                 name = <span class="stringliteral">&quot;xsv&quot;</span> + str(rev) + <span class="stringliteral">&quot;.cfg&quot;</span>
<a name="l00200"></a>00200                 log.info(<span class="stringliteral">&quot;Working with latest config file revision &apos;&quot;</span> + name + <span class="stringliteral">&quot;&apos;.&quot;</span>)
<a name="l00201"></a>00201                 config_file = os.path.abspath(self.<a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#aa0c4e2ec37b4da80aa8d3482618da2d7" title="Working directory of the config manager.">directory</a> + <span class="stringliteral">&quot;/&quot;</span> + name)
<a name="l00202"></a>00202             <span class="keywordflow">else</span>:
<a name="l00203"></a>00203                 <span class="comment"># if no latest revision exists, create a new config</span>
<a name="l00204"></a>00204                 log.info(<span class="stringliteral">&quot;No latest revision found, working with new/empty config.&quot;</span>)
<a name="l00205"></a>00205 
<a name="l00206"></a>00206         <span class="comment"># try reading the config file</span>
<a name="l00207"></a>00207         <span class="keywordflow">if</span> <span class="keywordflow">not</span> config_file <span class="keywordflow">is</span> <span class="keywordtype">None</span>:
<a name="l00208"></a>00208             self.<a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#a5c492abee663988219107c8052843055" title="Config object that is being worked on after reading.">config</a>.readfp(open(config_file))
<a name="l00209"></a>00209 
<a name="l00210"></a>00210 
<a name="l00211"></a>00211     <span class="comment">## Returns the python config object from the class variable self.config</span>
<a name="l00212"></a>00212     <span class="comment">#</span>
<a name="l00213"></a>00213     <span class="comment"># Useful when you want to compare config values in the plotting tool to the</span>
<a name="l00214"></a>00214     <span class="comment"># ones in the database</span>
<a name="l00215"></a>00215     <span class="comment">#</span>
<a name="l00216"></a>00216     <span class="comment"># @param self The object pointer</span>
<a name="l00217"></a>00217     <span class="comment"># @return Python config object</span>
<a name="l00218"></a><a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#a37aa8b5e8c9cdb0f3ad96edf6421142b">00218</a>     <span class="keyword">def </span><a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#a37aa8b5e8c9cdb0f3ad96edf6421142b" title="Returns the python config object from the class variable self.config.">get_config</a>(self):
<a name="l00219"></a>00219         <span class="keywordflow">return</span> self.<a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#a5c492abee663988219107c8052843055" title="Config object that is being worked on after reading.">config</a>
<a name="l00220"></a>00220 
<a name="l00221"></a>00221 
<a name="l00222"></a>00222     <span class="comment">## Updates config_file for a given sample_list</span>
<a name="l00223"></a>00223     <span class="comment">#</span>
<a name="l00224"></a>00224     <span class="comment"># Searches for entries from sample_list in self.config and compares with</span>
<a name="l00225"></a>00225     <span class="comment"># potential database entries. If differences are found, a new config file</span>
<a name="l00226"></a>00226     <span class="comment"># revision with updated entires is created. Default value for config_file is</span>
<a name="l00227"></a>00227     <span class="comment"># the latest revision in the working directory. Return value indicates if</span>
<a name="l00228"></a>00228     <span class="comment"># the update was succesful.</span>
<a name="l00229"></a>00229     <span class="comment">#</span>
<a name="l00230"></a>00230     <span class="comment"># @param self The object pointer    </span>
<a name="l00231"></a>00231     <span class="comment"># @param sample_list List of samples to update in the config file</span>
<a name="l00232"></a>00232     <span class="comment"># @param config_file Config file to update. Default is the latest revision</span>
<a name="l00233"></a>00233     <span class="comment"># of config files</span>
<a name="l00234"></a>00234     <span class="comment"># @return True if the update is succesful or unnecessary, else False.</span>
<a name="l00235"></a><a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#a27b570c55460cfb6f83d7853229ed288">00235</a>     <span class="keyword">def </span><a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#a27b570c55460cfb6f83d7853229ed288" title="Updates config_file for a given sample_list.">update_config</a>(self, sample_list, config_file=None):
<a name="l00236"></a>00236         <span class="comment"># read config if one is given</span>
<a name="l00237"></a>00237         <span class="keywordflow">if</span> <span class="keywordflow">not</span> config_file <span class="keywordflow">is</span> <span class="keywordtype">None</span>:
<a name="l00238"></a>00238             self.<a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#ac89ecf7e79e524b16e400450c0e6b8da" title="Reads the given config_file into the class variable self.config.">read_config</a>(config_file)
<a name="l00239"></a>00239 
<a name="l00240"></a>00240         <span class="comment"># loop over sample list and update the values</span>
<a name="l00241"></a>00241         log.info(<span class="stringliteral">&quot;Updating config...&quot;</span>)
<a name="l00242"></a>00242         up_to_date = <span class="keyword">True</span>
<a name="l00243"></a>00243         <span class="keywordflow">for</span> sample <span class="keywordflow">in</span> sample_list:
<a name="l00244"></a>00244             up_to_date = self.<a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#a515c625559081e827ce5aaba14e84287" title="Compares sample values with database entry.">compare_sample</a>(sample) <span class="keywordflow">and</span> up_to_date
<a name="l00245"></a>00245 
<a name="l00246"></a>00246         <span class="comment"># write revision if necessary</span>
<a name="l00247"></a>00247         <span class="keywordflow">if</span> up_to_date:
<a name="l00248"></a>00248             log.info(<span class="stringliteral">&quot;Config file is up to date. Nothing to be done.&quot;</span>)
<a name="l00249"></a>00249             <span class="keywordflow">return</span> <span class="keyword">True</span>
<a name="l00250"></a>00250         <span class="keywordflow">else</span>:
<a name="l00251"></a>00251             <span class="comment"># set timestamp</span>
<a name="l00252"></a>00252             <span class="keywordflow">if</span> <span class="keywordflow">not</span> self.<a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#a5c492abee663988219107c8052843055" title="Config object that is being worked on after reading.">config</a>.has_section(<span class="stringliteral">&quot;misc&quot;</span>):
<a name="l00253"></a>00253                 self.<a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#a5c492abee663988219107c8052843055" title="Config object that is being worked on after reading.">config</a>.add_section(<span class="stringliteral">&quot;misc&quot;</span>)
<a name="l00254"></a>00254             self.<a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#a5c492abee663988219107c8052843055" title="Config object that is being worked on after reading.">config</a>.set(<span class="stringliteral">&quot;misc&quot;</span>, <span class="stringliteral">&quot;timestamp&quot;</span>, datetime.datetime.strftime(datetime.datetime.now(),
<a name="l00255"></a>00255                                                                             <span class="stringliteral">&quot;%Y-%m-%d %H:%M:%S&quot;</span>))
<a name="l00256"></a>00256             <span class="comment"># create and write file</span>
<a name="l00257"></a>00257             rev = self.<a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#a46dc3b580b589e3a82ed82bcad8e64d5" title="Returns the latest revision of the config files named &amp;#39;xsv123.cfg&amp;#39;.">latest_revision</a>()
<a name="l00258"></a>00258             file_name = <span class="stringliteral">&quot;xsv&quot;</span> + str(rev + 1 <span class="keywordflow">if</span> <span class="keywordflow">not</span> rev <span class="keywordflow">is</span> <span class="keywordtype">None</span> <span class="keywordflow">else</span> 1) + <span class="stringliteral">&quot;.cfg&quot;</span>
<a name="l00259"></a>00259             with open(self.<a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#aa0c4e2ec37b4da80aa8d3482618da2d7" title="Working directory of the config manager.">directory</a> + <span class="stringliteral">&quot;/&quot;</span> + file_name, <span class="stringliteral">&quot;w&quot;</span>) <span class="keyword">as</span> f:
<a name="l00260"></a>00260 
<a name="l00261"></a>00261                 self.<a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#a5c492abee663988219107c8052843055" title="Config object that is being worked on after reading.">config</a>.write(f)
<a name="l00262"></a>00262             log.info(<span class="stringliteral">&quot;Succesfully updated config file. Latest revision is now &apos;&quot;</span> + file_name + <span class="stringliteral">&quot;&apos;.&quot;</span>)
<a name="l00263"></a>00263             <span class="keywordflow">return</span> <span class="keyword">True</span>
<a name="l00264"></a>00264 
<a name="l00265"></a>00265 
<a name="l00266"></a>00266     <span class="comment">## Update the latest revision of config files if older than age_in_hours</span>
<a name="l00267"></a>00267     <span class="comment">#</span>
<a name="l00268"></a>00268     <span class="comment"># Calls update_config(sample_list) if the timestamp is older than</span>
<a name="l00269"></a>00269     <span class="comment"># age_in_hours.</span>
<a name="l00270"></a>00270     <span class="comment">#</span>
<a name="l00271"></a>00271     <span class="comment"># @param self The object pointer</span>
<a name="l00272"></a>00272     <span class="comment"># @param sample_list List of samples to update in the config file</span>
<a name="l00273"></a>00273     <span class="comment"># @param age_in_hours Age of the latest revision in hours after which it</span>
<a name="l00274"></a>00274     <span class="comment"># should be updated</span>
<a name="l00275"></a>00275     <span class="comment"># @return True if the update is succesful or unnecessary, else False.</span>
<a name="l00276"></a><a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#a95db1f8a39d1df9c0e96a7f054a2d956">00276</a>     <span class="keyword">def </span><a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#a95db1f8a39d1df9c0e96a7f054a2d956" title="Update the latest revision of config files if older than age_in_hours.">auto_update</a>(self, sample_list, age_in_hours=24):
<a name="l00277"></a>00277         <span class="comment"># read the default/latest config</span>
<a name="l00278"></a>00278         self.<a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#ac89ecf7e79e524b16e400450c0e6b8da" title="Reads the given config_file into the class variable self.config.">read_config</a>()
<a name="l00279"></a>00279         <span class="comment"># compare timestamp to current time</span>
<a name="l00280"></a>00280         <span class="keywordflow">if</span> self.<a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#a5c492abee663988219107c8052843055" title="Config object that is being worked on after reading.">config</a>.has_option(<span class="stringliteral">&quot;misc&quot;</span>, <span class="stringliteral">&quot;timestamp&quot;</span>):
<a name="l00281"></a>00281             timestamp = datetime.datetime.strptime(self.<a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#a5c492abee663988219107c8052843055" title="Config object that is being worked on after reading.">config</a>.get(<span class="stringliteral">&quot;misc&quot;</span>, <span class="stringliteral">&quot;timestamp&quot;</span>),
<a name="l00282"></a>00282                                                    <span class="stringliteral">&quot;%Y-%m-%d %H:%M:%S&quot;</span>)
<a name="l00283"></a>00283             delta = datetime.datetime.now() - timestamp
<a name="l00284"></a>00284             <span class="keywordflow">if</span> delta &lt; datetime.timedelta(hours=age_in_hours):
<a name="l00285"></a>00285                 log.info(<span class="stringliteral">&quot;Latest revision is newer than &quot;</span> + str(age_in_hours) + <span class="stringliteral">&quot;h. Skipping update.&quot;</span>)
<a name="l00286"></a>00286                 <span class="keywordflow">return</span> <span class="keyword">True</span>
<a name="l00287"></a>00287 
<a name="l00288"></a>00288         <span class="keywordflow">return</span> self.<a class="code" href="classdbconfigmanager_1_1DBConfigManager.html#a27b570c55460cfb6f83d7853229ed288" title="Updates config_file for a given sample_list.">update_config</a>(sample_list)
<a name="l00289"></a>00289 
<a name="l00290"></a>00290 <span class="comment">## main() method for testing purposes</span>
<a name="l00291"></a><a class="code" href="namespacedbconfigmanager.html#a18ca358e9cd6aeba5ad87f6a3e9759b6">00291</a> <span class="keyword">def </span><a class="code" href="namespacedbconfigmanager.html#a18ca358e9cd6aeba5ad87f6a3e9759b6" title="main() method for testing purposes">main</a>():
<a name="l00292"></a>00292     logging.basicConfig(level=logging.DEBUG)
<a name="l00293"></a>00293     log.info(<span class="stringliteral">&quot;This is meant to be used as a library.&quot;</span>)
<a name="l00294"></a>00294 
<a name="l00295"></a>00295 
<a name="l00296"></a>00296 <span class="keywordflow">if</span> __name__ == <span class="stringliteral">&quot;__main__&quot;</span>:
<a name="l00297"></a>00297     sys.exit(main())
</pre></div></div>
<!-- HTML footer for doxygen 1.8.5-->
<!-- start footer part -->
<!--BEGIN GENERATE_TREEVIEW-->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    $navpath
    <li class="footer">
      libs3a is part of TAPAS check out all parts of it on 
      <a href="https://github.com/Aachen-3A/TAPAS">github</a>.
      Documentation $generatedby
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="$relpath^doxygen.png" alt="doxygen"/></a> 1.6.1 </li>
  </ul>

</div>
<!--END GENERATE_TREEVIEW-->
<!--BEGIN !GENERATE_TREEVIEW-->
<hr class="footer"/><address class="footer"><small>

$generatedby &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="$relpath^doxygen.png" alt="doxygen"/>
</a> 1.6.1
</small></address>
<!--END !GENERATE_TREEVIEW-->
</body>
</html>
